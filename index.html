<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0,maximum-scale=1.0,user-scalable=no"
    />
    <title>Foresee Contable</title>

    <!-- PWA: manifest + theme-color -->
    <link rel="manifest" href="./manifest.webmanifest" />
    <meta name="theme-color" content="#007bff" />

    <!-- iOS (Safari) para modo standalone -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Contable" />
    <link
      rel="apple-touch-icon"
      href="https://res.cloudinary.com/datwdagbf/image/upload/v1761960891/ingresos2_metwsi.png"
    />

    <link
      rel="icon"
      type="image/png"
      href="https://res.cloudinary.com/datwdagbf/image/upload/v1761960891/ingresos2_metwsi.png"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- PASO 1: AÑADIR LOS SCRIPTS DE FIREBASE (Módulos) -->
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
      import {
        getAuth,
        signInWithCustomToken,
        onAuthStateChanged,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut,
      } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
      import {
        getFirestore,
        doc,
        setDoc,
        addDoc,
        updateDoc,
        deleteDoc,
        onSnapshot,
        collection,
        query,
        getDocs,
        writeBatch,
        serverTimestamp,
        setLogLevel, // Para ver logs de depuración
      } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

      // --- PASO 3: INICIALIZACIÓN DE FIREBASE Y AUTENTICACIÓN ---

      // Estas variables __firebase_config y __app_id son proporcionadas por el entorno
      // No necesitas definirlas, solo usarlas.
      // Import the functions you need from the SDKs you need
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: 'AIzaSyBtgB_ZdKgstU-ZOg_dfynrvAHm5AMKcEg',
        authDomain: 'contable-3b43a.firebaseapp.com',
        projectId: 'contable-3b43a',
        storageBucket: 'contable-3b43a.firebasestorage.app',
        messagingSenderId: '335441527492',
        appId: '1:335441527492:web:d78f01752a7390bb73ff91',
      };

      // Initialize Firebase
      const appId = firebaseConfig.appId;

      typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

      // Inicializamos la app de Firebase y obtenemos los servicios
      let app, auth, db;
      try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        setLogLevel('Debug'); // Mostramos logs detallados de Firestore en la consola
        console.log('Firebase inicializado correctamente.');
      } catch (error) {
        console.error('Error inicializando Firebase:', error);
        document.body.innerHTML =
          '<h1>Error al conectar con Firebase. Revisa la configuración.</h1>';
        // Detenemos la ejecución si Firebase no carga
        throw new Error('No se pudo inicializar Firebase.');
      }

      // Referencias a nuestros contenedores de UI
      const authContainer = document.getElementById('auth-container');
      const mainAppContainer = document.querySelector('.container');
      const loadingOverlay = document.getElementById('loading-overlay'); // Ya lo tenías

      // Referencias a los formularios de Auth
      const loginForm = document.getElementById('login-form');
      const registerForm = document.getElementById('register-form');
      const authToggle = document.getElementById('auth-toggle');
      const authMessage = document.getElementById('auth-message');

      // Botón de Logout (que añadimos en el header)
      const logoutBtn = document.getElementById('logout-btn-header');

      // Un objeto para guardar los "listeners" de Firestore y poder cerrarlos al hacer logout
      window.firestoreListeners = [];

      // --- El "Vigilante" de Autenticación ---
      // Esta función es el corazón de la autenticación. Se ejecuta CADA VEZ que el estado de login cambia.
      onAuthStateChanged(auth, (user) => {
        if (user) {
          // --- ESTADO: Usuario LOGUEADO ---
          console.log('Usuario logueado:', user.uid);

          // Ocultamos la "puerta" (login) y mostramos la "casa" (app)
          authContainer.classList.add('hidden');
          mainAppContainer.classList.remove('hidden');
          loadingOverlay.classList.remove('active'); // Ocultar carga si estaba visible
          authMessage.textContent = ''; // Limpiar mensajes de error

          // Obtenemos el ID del usuario
          const userId = user.uid;

          // Iniciamos tu lógica de la app, pero ahora pasándole las herramientas de Firebase
          // y la información del usuario.
          initializeAppLogic(auth, db, userId, appId, user.email);
        } else {
          // --- ESTADO: Usuario DESLOGUEADO ---
          console.log('Usuario deslogueado.');

          // Mostramos la "puerta" (login) y ocultamos la "casa" (app)
          authContainer.classList.remove('hidden');
          mainAppContainer.classList.add('hidden');
          loadingOverlay.classList.remove('active');

          // Limpiamos los "listeners" de Firestore.
          // Esto es MUY IMPORTANTE para que un usuario no reciba datos del usuario anterior.
          firestoreListeners.forEach((unsubscribe) => unsubscribe());
          firestoreListeners = [];

          // Limpiamos la UI por si acaso (ej. la tabla de transacciones)
          document.getElementById('transactions-table-body').innerHTML = '';
          document.getElementById('bank-balances-grid').innerHTML = '';
          document.getElementById('category-list').innerHTML = '';
          document.getElementById('bank-list').innerHTML = '';
          // --- INICIO: LIMPIEZA UI DE PEDIDOS ---
          document.getElementById('product-list').innerHTML = '';
          document.getElementById('orders-list').innerHTML = '';
          // --- FIN: LIMPIEZA UI DE PEDIDOS ---
        }
      });

      // --- Manejadores de Eventos de Autenticación ---

      // Intentamos loguear al usuario con el token inicial (si existe)
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        console.log('Intentando login con __initial_auth_token...');
        loadingOverlay.classList.add('active'); // Mostrar carga mientras loguea
        signInWithCustomToken(auth, __initial_auth_token).catch((error) => {
          console.error('Error con signInWithCustomToken:', error);
          loadingOverlay.classList.remove('active'); // Ocultar carga si falla
          // Si el token falla, onAuthStateChanged se asegurará de mostrar el login
        });
      } else {
        // Si no hay token, onAuthStateChanged se ejecutará con (user = null)
        // y mostrará el formulario de login automáticamente.
        console.log('No se encontró __initial_auth_token, mostrando login manual.');
      }

      // 1. Manejador de Registro
      registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = registerForm['register-name'].value;
        const email = registerForm['register-email'].value;
        const password = registerForm['register-password'].value;

        loadingOverlay.classList.add('active');
        authMessage.textContent = '';

        try {
          // 1. Crear el usuario en Firebase Auth
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          const user = userCredential.user;
          console.log('Usuario registrado:', user.uid);

          // 2. Guardar información extra (su nombre) en Firestore
          // Usamos la ruta privada del usuario
          const userProfileDoc = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data');

          await setDoc(userProfileDoc, {
            name: name,
            email: user.email,
            createdAt: serverTimestamp(), // Guarda la fecha de creación en el servidor
          });

          console.log('Perfil de usuario guardado en Firestore.');
          // No necesitamos hacer nada más, onAuthStateChanged se disparará solo
          // y llamará a initializeAppLogic
        } catch (error) {
          console.error('Error en registro:', error);
          authMessage.textContent = `Error: ${error.message}`;
          loadingOverlay.classList.remove('active');
        }
      });

      // 2. Manejador de Login
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = loginForm['login-email'].value;
        const password = loginForm['login-password'].value;

        loadingOverlay.classList.add('active');
        authMessage.textContent = '';

        try {
          await signInWithEmailAndPassword(auth, email, password);
          // Login exitoso. onAuthStateChanged hará el resto.
          console.log('Login exitoso.');
        } catch (error) {
          console.error('Error en login:', error);
          authMessage.textContent = `Error: ${error.message}`;
          loadingOverlay.classList.remove('active');
        }
      });

      // 3. Manejador de Logout
      logoutBtn.addEventListener('click', () => {
        signOut(auth).catch((error) => {
          console.error('Error al hacer logout:', error);
        });
      });

      // 4. Toggle entre Login y Registro
      authToggle.addEventListener('click', (e) => {
        e.preventDefault();
        const isLogin = loginForm.classList.contains('hidden');
        if (isLogin) {
          // Cambiar a Login
          loginForm.classList.remove('hidden');
          registerForm.classList.add('hidden');
          authToggle.textContent = '¿No tienes cuenta? Regístrate';
        } else {
          // Cambiar a Registro
          loginForm.classList.add('hidden');
          registerForm.classList.remove('hidden');
          authToggle.textContent = '¿Ya tienes cuenta? Inicia sesión';
        }
        authMessage.textContent = ''; // Limpiar errores al cambiar
      });

      // --- FIN PASO 3 ---
    </script>

    <style>
      /* Estilos Generales y Variables (Sin cambios) */
      :root {
        --primary-blue: #007bff;
        --primary-blue-dark: #0056b3;
        --primary-blue-light: #cce5ff;
        --secondary-blue: #17a2b8;
        --secondary-blue-dark: #117a8b;
        --light-gray: #f8f9fa;
        --medium-gray: #e9ecef;
        --dark-gray: #6c757d;
        --text-color: #343a40;
        --background-color: #ffffff;
        --border-color: #dee2e6;
        --success-color: #28a745;
        --success-light: #d4edda;
        --danger-color: #dc3545;
        --danger-light: #fbebee;
        --warning-color: #ffc107;
        --info-color: #17a2b8;
        --white: #fff;
        --shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html {
        height: 100%;
      }

      body {
        font-family: 'Inter', sans-serif;
        background-color: var(--light-gray);
        color: var(--text-color);
        line-height: 1.6;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      /* --- PASO 2: CSS PARA LA AUTENTICACIÓN --- */
      #auth-container {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        width: 100%;
        min-height: 100vh;
        padding: 1rem;
        background-color: var(--light-gray);
      }

      .auth-card {
        width: 100%;
        max-width: 400px;
        background-color: var(--white);
        padding: 2rem;
        border-radius: 8px;
        box-shadow: var(--shadow);
      }

      .auth-card h2 {
        text-align: center;
        color: var(--primary-blue-dark);
        margin-bottom: 1.5rem;
      }

      .auth-card .form-group {
        margin-bottom: 1rem;
      }

      .auth-card input[type='text'],
      .auth-card input[type='email'],
      .auth-card input[type='password'] {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 5px;
        font-size: 1rem;
      }

      .auth-card .btn-primary {
        width: 100%;
        padding: 0.75rem;
        font-size: 1rem;
        margin-top: 1rem;
      }

      .auth-toggle-link {
        display: block;
        text-align: center;
        margin-top: 1rem;
        color: var(--primary-blue);
        cursor: pointer;
        font-size: 0.9rem;
      }
      .auth-toggle-link:hover {
        text-decoration: underline;
      }

      #auth-message {
        color: var(--danger-color);
        text-align: center;
        margin-bottom: 1rem;
        min-height: 1.2em; /* Evitar saltos de layout */
        font-size: 0.9rem;
      }

      /* Tu CSS existente */
      .container {
        width: 95%;
        max-width: 1200px;
        margin: 1rem auto;
        padding: 1rem;
        background-color: var(--background-color);
        border-radius: 8px;
        box-shadow: var(--shadow);
        flex-grow: 1;
        /* display: none;  -> NO ES NECESARIO SI USAMOS LA CLASE .hidden */
      }

      .hidden {
        display: none !important;
      }

      /* Encabezado */
      header {
        background-color: var(--primary-blue);
        color: var(--white);
        padding: 0.5rem;
        text-align: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        border-radius: 12px;
        /* Añadido para Logout */
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 10000;
        margin-top: 4rem;
        margin-bottom: 2rem;
        display: none;
      }

      header h1 {
        margin: 0;
        font-size: 2rem;
      }

      #user-greeting {
        margin: 0;
        font-size: 0.9rem;
      }

      #logout-btn {
        background-color: var(--white);
        color: var(--primary-blue);
        border: none;
        padding: 0.4rem 0.8rem;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.8rem;
        transition: background-color 0.2s, color 0.2s;
      }

      #logout-btn:hover {
        background-color: var(--primary-blue-light);
      }

      /* Zona de Saludo y Logout */
      .header-user-zone {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .logo-nav {
        background: #007bff;
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.25rem;
        border-radius: 100%;
        cursor: pointer;
        margin-right: 5rem;
      }

      .logo-nav img {
        height: 60px;
        width: auto;
      }

      /* Navegación */
      nav {
        /*background-color: var(--medium-gray);*/
        background-color: var(--white);
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
        border-radius: 5px;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        width: 100%;
        z-index: 1000;
        padding-left: 1rem;
        padding-right: 1rem;
      }

      nav ul {
        list-style: none;
        display: flex;
        justify-content: flex-start;
        /* flex-wrap: wrap; */ /* <-- LÍNEA ORIGINAL COMENTADA */
        flex-wrap: nowrap; /* <-- AÑADIDO: Mantiene todo en una línea */
        gap: 0.25rem;
        overflow-x: auto; /* <-- AÑADIDO: Permite el scroll horizontal */
        overflow-y: hidden; /* <-- AÑADIDO: Evita el scroll vertical accidental */
      }
      /* Oculta la barra de scroll pero mantiene la funcionalidad */
      nav ul::-webkit-scrollbar {
        display: none; /* Para Chrome, Safari y Opera */
      }
      nav ul {
        -ms-overflow-style: none; /* Para IE y Edge */
        scrollbar-width: none; /* Para Firefox */
      }

      nav button {
        background-color: transparent;
        border: none;
        color: var(--dark-gray);
        padding: 0.5rem 1rem;
        cursor: pointer;
        font-size: 1rem;
        border-radius: 5px;
        transition: background-color 0.2s, color 0.2s;
      }

      nav button:hover {
        background-color: var(--primary-blue-light);
        color: var(--primary-blue-dark);
      }

      nav button.active {
        background-color: var(--primary-blue);
        color: var(--white);
        font-weight: 600;
      }

      /* Paneles de Contenido */
      .tab-pane {
        margin-top: 3rem;
        display: none;
        padding-left: 1rem;
        padding-right: 1rem;
        border: 1px solid var(--border-color);
        border-radius: 5px;
        background-color: var(--background-color);
      }

      .tab-pane.active {
        display: block;
      }

      h2 {
        color: var(--primary-blue-dark);
        margin-bottom: 1rem;
        border-bottom: 2px solid var(--primary-blue-light);
        padding-bottom: 0.5rem;
      }

      /* Botones */
      .btn {
        display: inline-block;
        padding: 0.6rem 1.2rem;
        font-size: 0.9rem;
        font-weight: 500;
        text-align: center;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.2s, border-color 0.2s, color 0.2s;
        border: 1px solid transparent;
        text-decoration: none;
        white-space: nowrap;
      }

      .btn:disabled {
        background-color: var(--medium-gray);
        border-color: var(--medium-gray);
        color: var(--dark-gray);
        cursor: not-allowed;
        opacity: 0.7;
      }

      .btn-primary {
        background-color: var(--primary-blue);
        color: var(--white);
        border-color: var(--primary-blue);
      }

      .btn-primary:hover:not(:disabled) {
        background-color: var(--primary-blue-dark);
        border-color: var(--primary-blue-dark);
      }

      .btn-danger {
        background-color: var(--danger-color);
        color: var(--white);
        border-color: var(--danger-color);
      }

      .btn-danger:hover:not(:disabled) {
        background-color: #c82333;
        border-color: #bd2130;
      }

      .btn-secondary {
        background-color: var(--dark-gray);
        color: var(--white);
        border-color: var(--dark-gray);
      }

      .btn-secondary:hover:not(:disabled) {
        background-color: #5a6268;
        border-color: #545b62;
      }

      /* Estilo Botón Mostrar Filtros */
      #toggle-filters-btn {
        display: none; /* Oculto en desktop */
        background-color: var(--secondary-blue);
        color: var(--white);
        border-color: var(--secondary-blue);
      }
      #toggle-filters-btn:hover {
        background-color: var(--secondary-blue-dark);
        border-color: #117a8b;
      }
      #toggle-filters-btn svg {
        width: 16px;
        height: 16px;
        margin-right: 0.5rem;
        vertical-align: text-bottom; /* Alinear ícono con texto */
      }

      .btn-icon {
        background: none;
        border: none;
        padding: 0.3rem;
        cursor: pointer;
        vertical-align: middle;
        line-height: 1;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s;
      }
      .btn-icon:hover {
        background-color: var(--medium-gray);
      }

      .btn-icon svg {
        width: 16px;
        height: 16px;
      }
      .mobile-options-btn svg {
        width: 18px;
        height: 18px;
        color: var(--dark-gray);
      }

      .edit-btn svg {
        color: var(--primary-blue);
      }
      .delete-btn svg {
        color: var(--danger-color);
      }

      /* Tablas */
      .table-container {
        overflow-x: auto;
        margin-top: 1rem;
        border-radius: 8px; /* <-- AÑADE ESTO */
        overflow: hidden; /* <-- AÑADE ESTO (sobrescribe overflow-x) */
      }

      table {
        width: 100%;
        border-collapse: separate; /* <-- CAMBIA ESTO */
        border-spacing: 0; /* <-- AÑADE ESTO */
        margin-bottom: 1rem;
        font-size: 0.9rem;
      }

      th,
      td {
        padding: 0.6rem;
        text-align: left;
        vertical-align: middle;
      }

      thead th {
        background-color: var(--medium-gray);
        color: var(--primary-blue-dark);
        font-weight: 600;
      }

      /* --- INICIO: Esquinas redondeadas de la tabla --- */

      /* --- CABECERA (thead) --- */
      /* Arriba-Izquierda (Aplica a ambas vistas) */
      #transactions-table thead th:first-child,
      #products-table thead th:first-child, /* AÑADIDO */
      #orders-table thead th:first-child {
        /* AÑADIDO */
        border-top-left-radius: 8px;
      }
      /* Arriba-Derecha (MÓVIL: th "Opciones") */
      #transactions-table thead th:last-child,
      #products-table thead th:last-child, /* AÑADIDO */
      #orders-table thead th:last-child {
        /* AÑADIDO */
        border-top-right-radius: 8px;
      }

      /* --- PIE DE TABLA (tfoot) --- */

      /* Abajo-Izquierda (MÓVIL) */
      #transactions-table tfoot tr.mobile-totals-row:last-of-type td:first-child {
        border-bottom-left-radius: 8px;
      }
      /* Abajo-Derecha (MÓVIL: celda de "Opciones") */
      #transactions-table tfoot tr.mobile-totals-row:last-of-type td:last-child {
        border-bottom-right-radius: 8px;
      }

      /* Abajo-Izquierda (DESKTOP) - Selecciona la 3ra fila desde el final */
      #transactions-table tfoot tr:nth-last-of-type(3) td:first-child {
        border-bottom-left-radius: 8px;
      }
      /* Abajo-Derecha (DESKTOP) - Selecciona la 3ra fila desde el final Y la 2da celda desde el final */
      #transactions-table tfoot tr:nth-last-of-type(3) td:nth-last-child(2) {
        border-bottom-right-radius: 8px;
      }

      /* --- ARREGLO PARA DESKTOP (Pantallas > 768px) --- */
      @media (min-width: 769px) {
        /* Arriba-Derecha (DESKTOP: th "Acciones") */
        #transactions-table thead th:nth-last-child(2),
        #products-table thead th:last-child, /* AÑADIDO */
        #orders-table thead th:last-child {
          /* AÑADIDO */
          border-top-right-radius: 8px;
        }
        /* Quitamos el radio de la celda móvil (que está oculta) */
        #transactions-table thead th:last-child {
          border-top-right-radius: 0;
        }
      }
      /* --- FIN: Esquinas redondeadas de la tabla --- */

      tbody tr:nth-child(even) {
        background-color: var(--light-gray);
      }

      tbody tr:hover {
        background-color: var(--primary-blue-light);
      }

      tfoot td {
        font-weight: 600;
        background-color: var(--medium-gray);
      }

      .income-text {
        color: var(--success-color);
      }
      .expense-text {
        color: var(--danger-color);
      }

      .align-right {
        text-align: right;
      }
      .align-center {
        text-align: center;
      }
      .no-wrap {
        white-space: nowrap;
      }

      /* Formularios */
      .form-group {
        margin-bottom: 1rem;
      }

      label {
        display: block;
        margin-bottom: 0.3rem;
        font-weight: 500;
        color: var(--dark-gray);
      }

      input[type='text'],
      input[type='number'],
      input[type='date'],
      input[type='month'], /* Añadido para filtro */
      select,
      textarea {
        /* <-- AÑADIDO TEXTAREA */
        width: 100%;
        padding: 0.6rem;
        border: 1px solid var(--border-color);
        border-radius: 5px;
        font-size: 0.9rem;
        transition: border-color 0.2s, box-shadow 0.2s;
        font-family: 'Inter', sans-serif; /* <-- AÑADIDO */
      }

      /* Estilo para Checkbox (NUEVO) */
      input[type='checkbox'] {
        width: 16px;
        height: 16px;
        margin-right: 0.5rem;
        cursor: pointer;
      }

      input[type='text']:focus,
      input[type='number']:focus,
      input[type='date']:focus,
      input[type='month']:focus, /* Añadido para filtro */
      select:focus,
      textarea:focus {
        /* <-- AÑADIDO TEXTAREA */
        outline: none;
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
      }

      .input-error-message {
        color: var(--danger-color);
        font-size: 0.8rem;
        margin-top: 0.25rem;
        display: none;
      }
      .input-error-message.active {
        display: block;
      }

      /* Controles de Filtro */
      .filters-container {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
        align-items: flex-end; /* Alinear botón e inputs */
      }
      .filters-container .form-group {
        flex-grow: 1;
        margin-bottom: 0;
      }
      .filters-container #filter-bank {
        min-width: 200px;
      }
      .filters-container #filter-month {
        min-width: 150px;
      }
      .filters-container .btn {
        flex-shrink: 0; /* Evitar que el botón se encoja */
      }

      /* Modales */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        padding: 1rem;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background-color: var(--background-color);
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        width: 100%;
        max-width: 500px; /* Ancho estándar para modales */
        max-height: 95vh;
        display: flex;
        flex-direction: column;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 0.25rem;
        margin-bottom: 0.25rem;
      }

      .modal-header h2 {
        margin: 0;
        padding: 0;
        border: none;
        font-size: 1.25rem;
      }

      .modal-body {
        flex-grow: 1;
        overflow-y: auto;
        margin-bottom: 1rem;
      }

      .modal-footer {
        border-top: 1px solid var(--border-color);
        padding-top: 1rem;
        text-align: right;
      }

      .modal-footer .btn + .btn {
        margin-left: 0.5rem;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--dark-gray);
        line-height: 1;
      }
      .close-btn:hover {
        color: var(--text-color);
      }

      /* Configuración Específica */
      .config-section {
        margin-bottom: 2rem;
        padding: 1rem;
        border: 1px solid var(--border-color);
        border-radius: 5px;
      }
      .config-section h3 {
        margin-top: 0;
        margin-bottom: 1rem;
        font-size: 1.1rem;
        color: var(--primary-blue);
      }
      .config-list {
        list-style: none;
        padding: 0;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        border-radius: 5px;
        padding: 0.5rem;
      }
      .config-list li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem;
        border-bottom: 1px solid var(--medium-gray);
      }
      .config-list li:last-child {
        border-bottom: none;
      }
      .config-item-content {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        overflow: hidden; /* Evitar que el texto largo desborde */
        text-overflow: ellipsis; /* Añadir puntos suspensivos */
        white-space: nowrap; /* Evitar salto de línea */
        flex-grow: 1; /* Ocupar espacio disponible */
        min-width: 0; /* Necesario para que flexbox permita encoger */
      }
      .category-icon-small {
        width: 24px;
        height: 24px;
        vertical-align: middle;
        flex-shrink: 0; /* Evitar que el icono se encoja */
      }
      .config-list .btn-icon {
        flex-shrink: 0; /* Evitar que el botón se encoja */
      }

      /* NUEVO: Contenedor Checkbox Zona Peligrosa */
      .danger-zone-check-container {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background-color: var(--danger-light);
        padding: 0.75rem;
        border-radius: 5px;
        border: 1px solid var(--danger-color);
        margin-bottom: 1rem; /* Separar del botón */
      }
      .danger-zone-check-container input[type='checkbox'] {
        margin: 0;
        flex-shrink: 0;
      }
      .danger-zone-check-container label {
        margin: 0;
        color: var(--danger-color);
        font-weight: 500;
        user-select: none; /* Evitar seleccionar texto */
      }

      /* Icon Grid (Modal Categoría) */
      #category-icon-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
        gap: 1rem;
        padding: 1rem 0;
        max-height: 300px;
        overflow-y: auto;
      }

      .icon-option {
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        border: 2px solid var(--border-color);
        transition: all 0.2s ease-in-out;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--light-gray);
      }

      .icon-option:hover {
        transform: scale(1.1);
        border-color: var(--primary-blue);
      }

      .icon-option.selected {
        border-color: var(--success-color);
        box-shadow: 0 0 5px var(--success-color);
        background-color: #d4edda;
      }

      .icon-option img {
        width: 40px;
        height: 40px;
      }

      /* Saldos */
      #bank-balances-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
      }

      .balance-card {
        background-color: var(--light-gray);
        border: 1px solid var(--border-color);
        padding: 1rem;
        border-radius: 5px;
        text-align: center;
        box-shadow: var(--shadow);
      }

      .balance-card h3 {
        margin-bottom: 0.5rem;
        color: var(--primary-blue-dark);
        font-size: 1rem;
      }

      .balance-amount {
        font-size: 1.5rem;
        font-weight: 600;
      }
      .balance-positive {
        color: var(--success-color);
      }
      .balance-negative {
        color: var(--danger-color);
      }

      /* Loading Overlay - SIN CAMBIOS */
      .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        justify-content: center;
        align-items: center;
        z-index: 2000;
      }
      .loading-overlay.active {
        display: flex;
      }
      .spinner {
        border: 4px solid var(--medium-gray);
        border-left-color: var(--primary-blue);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Footer Básico - SIN CAMBIOS */
      footer {
        margin-top: 2rem;
        padding: 1rem;
        text-align: center;
        font-size: 0.8rem;
        color: var(--dark-gray);
        border-top: 1px solid var(--border-color);
        background-color: var(--medium-gray);
      }

      /* Mensajes (No hay datos) - SIN CAMBIOS */
      .no-data-message {
        text-align: center;
        color: var(--dark-gray);
        padding: 2rem;
        font-style: italic;
      }

      /* Visibilidad por defecto (Desktop) */
      .mobile-date,
      .mobile-actions-col {
        display: none;
      }

      .full-date {
        display: inline;
      }

      .desktop-actions-col {
        display: table-cell;
      }

      .category-name-text {
        display: inline; /* Mostrar texto por defecto */
      }

      /* Por defecto, mostrar fila desktop y ocultar fila móvil */
      #transactions-table .desktop-totals-row {
        display: table-row;
      }
      #transactions-table .mobile-totals-row {
        display: none;
      }

      .logotipo {
        width: 180px;
        height: 100px;
        padding-left: 1rem;
      }

      .tab-button {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding-left: 18px;
        padding-right: 18px;
        margin-left: 2px;
        padding-top: 2px;
        padding-bottom: 4px;
        border-radius: 10px;
        /* background: var(--bg-dark-secondary); 
        background: #1f2937ba;*/
        border: none;
      }

      .tab-button img {
        height: 56px;
        width: 60px;
      }

      .tab-button span {
        font-size: 0.75rem;
        margin-top: 1px;
        color: var(--text-light-secondary);
        transition: color 0.2s ease-in-out;
        text-align: center;
        white-space: nowrap;
      }

      .tab-button:hover {
        color: var(--electric-blue);
        /* background-color: transparent; 
        background: #1f2937ba;*/
        border-bottom-color: var(--electric-blue);
        box-shadow: 0 0 8px var(--electric-blue), 0 0 15px var(--electric-blue),
          0 0 25px var(--electric-blue);
        inset: 0 0 10px rgba(14, 165, 233, 0.6);
      }

      .tab-button.active {
        box-shadow: 0 0 8px var(--bg-dark-tertiary), 0 0 15px var(--bg-dark-tertiary),
          0 0 25px var(--bg-dark-tertiary);
        inset: 0 0 5px rgba(112, 114, 115, 0.6);
      }

      /*
      /* --- INICIO: NUEVOS ESTILOS PARA EL MODAL DE CALCULADORA ---
      */

      /* Estilo del modal de calculadora, más pequeño que el estándar */
      #add-registro-calculator-modal .modal-content {
        max-width: 380px;
        padding: 0;
        border-radius: 10px;
        overflow: auto;
      }

      /* Estilos para el nuevo header del modal de calculadora */
      #add-registro-calculator-modal .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.25rem 0.5rem 0.25rem 1rem; /* Añadimos el padding que falta */
        border-bottom: 1px solid var(--border-color);
      }
      #add-registro-calculator-modal .modal-header h2 {
        margin: 0;
        padding: 0;
        border: none;
        font-size: 1.25rem;
      }

      /* Contenedor de los botones Ingreso/Gasto */
      .tipo-registro-selector {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0;
      }

      .tipo-registro-btn {
        background-color: var(--medium-gray);
        color: var(--dark-gray);
        border: none;
        padding: 0.25rem;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s, color 0.2s;
        border-bottom: 3px solid transparent;
      }

      /* Estilo del botón activo */
      .tipo-registro-btn.active.gasto {
        background-color: var(--danger-light);
        color: var(--danger-color);
        border-bottom-color: var(--danger-color);
      }
      .tipo-registro-btn.active.ingreso {
        background-color: var(--success-light);
        color: var(--success-color);
        border-bottom-color: var(--success-color);
      }

      /* Contenedor del formulario (fecha, comentario, etc.) */
      .registro-calculator-body {
        padding-left: 1rem;
        padding-right: 1rem;
        padding-bottom: 0rem;
        padding-top: 0rem;
        background-color: var(--white);
      }

      /* Contenedor de la fecha y el icono de comentario */
      .registro-controles-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
      }

      /* Estilo del input de fecha */
      #registro-fecha {
        border: none;
        background-color: var(--light-gray);
        padding: 0.5rem 0.75rem;
        border-radius: 5px;
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--text-color);
      }

      /* Botón para mostrar/ocultar comentario */
      #registro-comentario-toggle {
        background-color: var(--light-gray);
        color: var(--dark-gray);
        width: 38px;
        height: 38px;
        border-radius: 50%;
      }
      #registro-comentario-toggle.active {
        background-color: var(--primary-blue-light);
        color: var(--primary-blue-dark);
      }
      #registro-comentario-toggle svg {
        width: 20px;
        height: 20px;
      }

      /* Campo de texto del comentario (oculto por defecto) */
      #registro-comentario-input {
        margin-top: 0.5rem;
      }

      /* Display de la calculadora */
      #registro-display-wrapper {
        padding: 0.5rem 0.5rem;
        background-color: var(--medium-gray);
        border-bottom: 1px solid var(--border-color);
        transition: background-color 0.2s;
      }
      #registro-display {
        background-color: var(--white);
        border: 1px solid var(--border-color);
        border-radius: 5px;
        padding-top: 0rem;
        padding-bottom: 0rem;
        padding-left: 0.75rem;
        padding-right: 0.75rem;
        font-size: 1.25rem;
        font-weight: 600;
        text-align: right;
        color: var(--text-color);
        width: 100%;
        overflow-x: auto; /* Para números muy largos */
        white-space: nowrap;
      }

      /* Keypad de la Calculadora */
      #calculadora-keypad {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
        padding: 0.5rem;
        background-color: var(--medium-gray);
      }

      .calc-btn {
        background-color: var(--white);
        border: none;
        border-right: 1px solid var(--medium-gray);
        border-top: 1px solid var(--medium-gray);
        padding-left: 5px;
        padding-right: 5px;
        padding-top: 7px;
        padding-bottom: 7px;
        font-size: 1.25rem;
        font-weight: 500;
        color: var(--text-color);
        cursor: pointer;
        transition: background-color 0.1s;
      }
      .calc-btn:hover {
        background-color: var(--light-gray);
      }
      .calc-btn.operator {
        background-color: var(--light-gray);
        color: var(--primary-blue);
        font-weight: 600;
      }
      /* Botón de Total */
      #btn-total {
        grid-column: span 4;
        background-color: var(--primary-blue);
        color: var(--white);
        font-size: 1.25rem;
        font-weight: 600;
        border: none;
      }
      #btn-total:hover {
        background-color: var(--primary-blue-dark);
      }

      /* --- TEMAS DINÁMICOS PARA EL MODAL DE CALCULADORA --- */

      /* Tema Gasto (Rojo) */
      .modal-gasto #registro-display-wrapper {
        background-color: var(--danger-light);
      }
      .modal-gasto #registro-display {
        border-color: #f5c6cb;
      }
      .modal-gasto #btn-total {
        background-color: var(--danger-color);
      }
      .modal-gasto #btn-total:hover {
        background-color: #c82333;
      }

      /* Tema Ingreso (Verde) */
      .modal-ingreso #registro-display-wrapper {
        background-color: var(--success-light);
      }
      .modal-ingreso #registro-display {
        border-color: #c3e6cb;
      }
      .modal-ingreso #btn-total {
        background-color: var(--success-color);
      }
      .modal-ingreso #btn-total:hover {
        background-color: #218838;
      }

      /* --- FIN: NUEVOS ESTILOS PARA EL MODAL DE CALCULADORA --- */

      /*
      /* --- INICIO: NUEVOS ESTILOS PARA EL MODAL DE SELECCIÓN DE CATEGORÍA ---
      /* (Estilos basados en index 0.0.5.0.html)
      */

      #category-select-modal .modal-content {
        max-width: 450px;
      }

      /* Estilos para la cuadrícula del modal de selección de categoría */
      #category-select-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 1rem;
        max-height: 50vh;
        overflow-y: auto;
        padding: 0.5rem;
      }

      /* Estilos para cada ítem individual en la cuadrícula */
      .category-select-option {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 12px 8px;
        border-radius: 8px;
        cursor: pointer;
        border: 1px solid var(--border-color);
        background-color: var(--light-gray);
        transition: all 0.2s ease-in-out;
        text-align: center;
      }

      .category-select-option:hover {
        transform: scale(1.05);
        border-color: var(--primary-blue);
        box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2);
      }

      /* Controla el tamaño de la imagen (ícono) */
      .category-select-option img {
        width: 40px;
        height: 40px;
        margin-bottom: 4px;
      }

      /* Controla el tamaño del texto debajo del ícono */
      .category-select-option span {
        font-size: 0.75rem;
        line-height: 1.3;
        color: var(--text-color);
        font-weight: 500;
        word-break: break-word;
      }
      /*
      /* --- FIN: NUEVOS ESTILOS PARA EL MODAL DE SELECCIÓN DE CATEGORÍA ---
      */

      /* --- INICIO: ESTILOS PEDIDOS Y PRODUCTOS --- */

      /* Contenedor flexible para formularios (para poner 2 columnas en desktop) */
      .form-container-flex {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      /* Formulario simple para añadir */
      .simple-add-form {
        display: flex;
        gap: 0.5rem;
        align-items: flex-end;
        margin-bottom: 1rem;
        flex-wrap: wrap;
      }
      .simple-add-form .form-group {
        flex-grow: 1;
        margin-bottom: 0;
      }
      .simple-add-form .btn {
        flex-shrink: 0;
      }

      /* Estilos para la lista de Pedidos */
      #orders-list,
      #product-list {
        list-style: none;
        padding: 0;
        display: grid;
        grid-template-columns: 1fr; /* 1 columna en móvil por defecto */
        gap: 1rem;
      }

      .order-card,
      .product-card {
        background-color: var(--white);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        box-shadow: var(--shadow);
        padding: 1rem;
      }

      .order-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        border-bottom: 1px solid var(--medium-gray);
        padding-bottom: 0.75rem;
        margin-bottom: 0.75rem;
      }
      .order-card-header h3 {
        margin: 0;
        color: var(--primary-blue-dark);
      }
      .order-card-status {
        font-size: 0.8rem;
        font-weight: 600;
        padding: 0.25rem 0.5rem;
        border-radius: 5px;
        color: var(--white);
      }
      .status-pending {
        background-color: var(--warning-color);
        color: var(--text-color);
      }
      .status-completed {
        background-color: var(--success-color);
      }

      .order-card-body p {
        margin-bottom: 0.5rem;
      }
      .order-card-body strong {
        color: var(--dark-gray);
      }

      .order-card-products {
        list-style: none;
        padding: 0.5rem 0 0 1rem;
        font-size: 0.9rem;
      }
      .order-card-products li {
        color: var(--text-color);
      }

      .order-card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--medium-gray);
      }

      .order-total {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--primary-blue);
      }

      /* Checkbox de confirmación de entrega */
      .confirm-delivery-container {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background-color: var(--success-light);
        padding: 0.5rem 0.75rem;
        border-radius: 5px;
        border: 1px solid var(--success-color);
      }
      .confirm-delivery-container label {
        margin: 0;
        color: var(--success-color);
        font-weight: 600;
        cursor: pointer;
      }
      .confirm-delivery-container input[type='checkbox'] {
        margin: 0;
        width: 18px;
        height: 18px;
      }

      /* Estilos para la lista de Productos (en Configuración) */
      .product-card {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .product-info {
        flex-grow: 1;
      }
      .product-info h4 {
        margin: 0;
        color: var(--primary-blue-dark);
      }
      .product-info p {
        margin: 0;
        color: var(--dark-gray);
        font-size: 0.9rem;
      }
      .product-price {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--success-color);
        margin-left: 1rem;
      }
      .product-actions {
        flex-shrink: 0;
        margin-left: 1rem;
      }

      /* Notificaciones en Dashboard */
      #dashboard-notificaciones {
        background-color: var(--warning-color);
        border: 1px solid #ffc107;
        border-radius: 5px;
        padding: 1rem;
        margin-bottom: 1rem;
        background-color: #fff3cd;
        border-color: #ffeeba;
        color: #856404;
      }
      #dashboard-notificaciones h3 {
        margin: 0 0 0.5rem 0;
        color: #856404;
      }
      #upcoming-deliveries-list {
        list-style: none;
        padding: 0;
      }
      #upcoming-deliveries-list li {
        padding: 0.25rem 0;
        border-bottom: 1px solid #ffeeba;
      }
      #upcoming-deliveries-list li:last-child {
        border-bottom: none;
      }

      /* Modal de Selección de Productos */
      #product-select-modal .modal-content {
        max-width: 450px;
      }
      #product-select-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 0.75rem;
        max-height: 60vh;
        overflow-y: auto;
      }
      .product-select-option {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background-color: var(--light-gray);
        cursor: pointer;
        transition: all 0.2s;
      }
      .product-select-option:hover {
        border-color: var(--primary-blue);
        box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2);
      }
      .product-select-option-info h4 {
        margin: 0;
        font-size: 1rem;
        color: var(--text-color);
      }
      .product-select-option-info p {
        margin: 0;
        font-size: 0.9rem;
        color: var(--success-color);
        font-weight: 500;
      }
      .product-select-option input[type='number'] {
        width: 60px;
        padding: 0.25rem 0.5rem;
        font-size: 0.9rem;
        text-align: center;
        margin-left: 0.5rem;
      }
      .product-select-option .btn {
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
        margin-left: 0.5rem;
      }

      /* Layout responsive para formularios */
      @media (min-width: 769px) {
        .form-container-flex {
          flex-direction: row;
        }
        .form-container-flex > div {
          flex: 1; /* Ambas columnas ocupan el 50% */
        }

        #orders-list {
          grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        }

        #product-list {
          grid-template-columns: 1fr;
        }
      }

      /* --- FIN: ESTILOS PEDIDOS Y PRODUCTOS --- */

      /* Media Queries (Modificado) */
      @media (max-width: 768px) {
        .logo-nav {
          margin-right: 5rem;
          display: none;
        }
        .tab-pane {
          margin-top: 5rem;
        }
        /* Ajuste para que el header de Auth no desaparezca en móvil */
        #auth-container {
          background-color: var(--white);
        }
        .auth-card {
          box-shadow: none;
          padding: 1rem;
        }

        .container {
          width: 100%;
          margin: 0; /* Quitar margen en móvil */
          padding: 0.5rem;
          border-radius: 0; /* Quitar bordes redondos */
          box-shadow: none; /* Quitar sombra */
        }

        /* MODIFICADO: Header SÍ se muestra en móvil, pero ajustado */
        header {
          flex-direction: column;
          gap: 0.5rem;
          padding: 0.75rem;
          text-align: center;
          display: none; /* Ocultar header en móvil */
        }
        header h1 {
          font-size: 1.25rem;
        }
        .header-user-zone {
          width: 100%;
          justify-content: space-between;
        }

        nav ul {
          gap: 0.5rem;
        }
        nav button {
          padding: 0.4rem 0.8rem;
          font-size: 0.9rem;
        }
        th,
        td {
          padding: 0.4rem;
          font-size: 0.85rem;
        }
        .modal-content {
          padding: 1rem;
          max-width: 95%;
        }

        /* Ajuste de filtros en móvil */
        .filters-container {
          flex-direction: column;
          align-items: stretch;
          gap: 0.5rem;
          display: none; /* NUEVO: Ocultar por defecto */
        }
        /* NUEVO: Clase para mostrar filtros con JS */
        .filters-container.show-mobile-filters {
          display: flex;
        }

        /* NUEVO: Mostrar botón de filtros en móvil */
        #toggle-filters-btn {
          display: inline-block;
          width: 100%;
          margin-top: 0.5rem;
          margin-bottom: 0.5rem; /* Espacio antes de la tabla */
        }

        .filters-container .form-group,
        .filters-container #filter-bank,
        .filters-container #filter-month,
        .filters-container .btn {
          width: 100%;
          min-width: 0;
        }

        /* --- INICIO: MODIFICACIONES TABLA MÓVIL --- */

        /* 1. Ocultar columnas no deseadas en móvil (SOLO en head y body) */
        #transactions-table thead th:nth-child(2), /* Descripción (thead) */
        #transactions-table tbody td:nth-child(2), /* Descripción (tbody) */
        #transactions-table thead th:nth-child(4), /* Banco (thead) */
        #transactions-table tbody td:nth-child(4), /* Banco (tbody) */
        #transactions-table .desktop-actions-col {
          /* Columna Acciones Desktop (en todo) */
          display: none;
        }

        /* 2. Mostrar columna de Opciones Móvil */
        #transactions-table .mobile-actions-col {
          display: table-cell;
        }

        /* 3. Ajustar columna Fecha */
        #transactions-table .full-date {
          display: none; /* Ocultar fecha completa */
        }
        #transactions-table .mobile-date {
          display: inline; /* Mostrar solo día */
          font-weight: 500;
        }
        #transactions-table th:nth-child(1), /* Centrar cabecera "Fecha" */
        #transactions-table td:nth-child(1) {
          /* Centrar celda del día */
          text-align: center;
        }

        /* 4. Ajustar columna Categoría */
        #transactions-table .category-name-text {
          display: none; /* Ocultar texto de categoría */
        }
        #transactions-table th:nth-child(3), /* Centrar cabecera "Categoría" */
        #transactions-table td:nth-child(3) {
          /* Centrar ícono */
          text-align: center;
        }

        /* Ocultar fila de totales de desktop */
        #transactions-table .desktop-totals-row {
          display: none;
        }
        /* Mostrar fila de totales de móvil */
        #transactions-table .mobile-totals-row {
          display: table-row;
        }

        .tab-button {
          padding-left: 2px;
          padding-right: 2px;
        }
        /* --- FIN: MODIFICACIONES TABLA MÓVIL --- */
      }

      /* ========================================= */
      /* --- ESTILOS PARA TOOLTIP DE INFORMACIÓN --- */
      /* ========================================= */

      /* Contenedor flexible para alinear icono categoría y botón info */
      .category-cell-content {
        display: flex;
        align-items: center;
        justify-content: center; /* Centrado en móvil */
        gap: 8px;
      }

      /* Botón de información (El círculo con la "i") */
      .info-btn {
        display: none; /* Oculto por defecto en escritorio */
        align-items: center;
        justify-content: center;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background-color: var(--white);
        color: var(--primary-blue); /* Color azul de tu tema */
        border: 1px solid var(--primary-blue);
        cursor: pointer;
        flex-shrink: 0;
        padding: 0;
        transition: all 0.2s ease;
      }

      .info-btn:hover,
      .info-btn:active {
        background-color: var(--primary-blue);
        color: var(--white);
        transform: scale(1.1);
      }

      /* La ventana flotante (Tooltip) */
      .info-tooltip {
        position: fixed;
        background-color: var(--text-color); /* Fondo oscuro */
        color: var(--white);
        padding: 0.75rem 1rem;
        border-radius: 6px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        font-size: 0.9rem;
        line-height: 1.4;
        max-width: 250px;
        z-index: 99999; /* Por encima de todo */
        opacity: 0;
        transform: translateY(10px);
        transition: opacity 0.2s ease, transform 0.2s ease;
        pointer-events: none;
      }

      .info-tooltip.visible {
        opacity: 1;
        transform: translateY(0);
      }

      /* --- REGLA IMPORTANTE: Mostrar solo en pantallas pequeñas --- */
      @media (max-width: 768px) {
        .info-btn {
          display: inline-flex; /* Se hace visible solo en móvil */
        }
        /* Ajuste para que la celda de categoría en móvil permita el flex */
        #transactions-table td:nth-child(3) {
          display: table-cell;
        }
      }
    </style>
  </head>

  <body>
    <!-- Overlay de carga (Sin cambios) -->
    <div class="loading-overlay" id="loading-overlay">
      <div class="spinner"></div>
    </div>

    <!-- PASO 2: AÑADIR LA UI DE AUTENTICACIÓN -->
    <!-- Esta es la "puerta" que se muestra al inicio -->
    <div id="auth-container">
      <div class="auth-card">
        <!-- Formulario de Login (visible por defecto) -->
        <form id="login-form">
          <h2>Iniciar Sesión</h2>
          <div id="auth-message"></div>
          <div class="form-group">
            <label for="login-email">Email</label>
            <input type="email" id="login-email" required />
          </div>
          <div class="form-group">
            <label for="login-password">Contraseña</label>
            <input type="password" id="login-password" required />
          </div>
          <button type="submit" class="btn btn-primary">Entrar</button>
        </form>

        <!-- Formulario de Registro (oculto por defecto) -->
        <form id="register-form" class="hidden">
          <h2>Crear Cuenta</h2>
          <div class="form-group">
            <label for="register-name">Nombre</label>
            <input type="text" id="register-name" required />
          </div>
          <div class="form-group">
            <label for="register-email">Email</label>
            <input type="email" id="register-email" required />
          </div>
          <div class="form-group">
            <label for="register-password">Contraseña (mín. 6 caracteres)</label>
            <input type="password" id="register-password" required minlength="6" />
          </div>
          <button type="submit" class="btn btn-primary">Registrarse</button>
        </form>

        <a id="auth-toggle" class="auth-toggle-link">¿No tienes cuenta? Regístrate</a>
      </div>
    </div>

    <!-- Tu aplicación principal, ahora oculta por defecto -->
    <div class="container hidden">
      <header>
        <div id="barr">
          <img
            src="https://res.cloudinary.com/datwdagbf/image/upload/v1756514680/logo_jkwegt.png"
            alt="Logo"
            class="logotipo"
          />
        </div>

        <h1>Gestor Contable</h1>
        <!-- Zona de saludo y botón de logout -->
        <div class="header-user-zone">
          <p id="user-greeting">Bienvenido</p>
          <button id="logout-btn-header" class="btn">Salir</button>
        </div>
      </header>

      <div class="container">
        <nav>
          <ul id="tabs">
            <li class="logo-nav">
              <img
                src="https://res.cloudinary.com/datwdagbf/image/upload/v1756514680/logo_jkwegt.png"
                alt="Logo"
                class="logotipo"
              />
            </li>
            <!-- Pestaña Registros -->
            <li>
              <button class="tab-button active" data-tab="registros">
                <img
                  src="https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514689/registro_mc8ed8.png"
                  alt="Icono Registros"
                />
                <span>Registros</span>
              </button>
            </li>
            <!-- Pestaña Saldos -->
            <li>
              <button class="tab-button" data-tab="saldos">
                <img
                  src="https://res.cloudinary.com/datwdagbf/image/upload/v1756889458/AA7C0FC4-9F29-48D3-BA63-CDF884DA716B_uwkqfp.png"
                  alt="Icono Saldos"
                />
                <span>Saldos</span>
              </button>
            </li>

            <!-- INICIO: NUEVA PESTAÑA PEDIDOS -->
            <li>
              <button class="tab-button" data-tab="pedidos">
                <img
                  src="https://res.cloudinary.com/datwdagbf/image/upload/v1761948696/Pedidos_kccmsd.png"
                  alt="Icono Pedidos"
                />
                <span>Pedidos</span>
              </button>
            </li>
            <!-- FIN: NUEVA PESTAÑA PEDIDOS -->

            <!-- INICIO: NUEVA PESTAÑA PRODUCTOS -->
            <li>
              <button class="tab-button" data-tab="productos">
                <img
                  src="https://res.cloudinary.com/datwdagbf/image/upload/v1761948696/cake_yvpgrk.png"
                  alt="Icono Productos"
                />
                <span>Productos</span>
              </button>
            </li>
            <!-- FIN: NUEVA PESTAÑA PRODUCTOS -->

            <!-- Pestaña Configuración -->
            <li>
              <button class="tab-button" data-tab="configuracion">
                <img
                  src="https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514668/configuracion_puo2ap.png"
                  alt="Icono Configuración"
                />
                <span>Configuración</span>
              </button>
            </li>
            <!-- Pestaña Salir -->
            <li>
              <button id="logout-btn-nav" class="tab-button">
                <img
                  src="https://res.cloudinary.com/datwdagbf/image/upload/v1756889218/51B410C2-D58E-47D8-9ECC-000296533E2C_udpy1y.png"
                  alt="Icono Salir"
                />
                <span>Salir</span>
              </button>
            </li>
          </ul>
        </nav>

        <main id="main-content">
          <!-- Sección Registros (Modificada) -->
          <div id="registros-content" class="tab-pane active">
            <h2>Transacciones</h2>

            <!-- INICIO: NOTIFICACIONES DE PEDIDOS -->
            <div id="dashboard-notificaciones" class="hidden">
              <h3>Próximas Entregas</h3>
              <ul id="upcoming-deliveries-list">
                <!-- Se llenará con JS -->
              </ul>
            </div>
            <!-- FIN: NOTIFICACIONES DE PEDIDOS -->

            <button class="btn btn-primary" id="add-transaction-btn">Añadir Transacción</button>

            <button class="btn" id="toggle-filters-btn">
              <svg
                viewBox="0 0 24 24"
                fill="currentColor"
                style="width: 16px; height: 16px; margin-right: 0.5rem; vertical-align: text-bottom"
              >
                <path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z"></path>
              </svg>
              <span>Mostrar Filtros</span>
            </button>

            <div class="filters-container" id="filters-container">
              <div class="form-group">
                <label for="filter-bank">Filtrar por Banco</label>
                <select id="filter-bank">
                  <option value="all">Todos los Bancos</option>
                </select>
              </div>
              <div class="form-group">
                <label for="filter-month">Filtrar por Mes</label>
                <input type="month" id="filter-month" />
              </div>
              <button class="btn btn-secondary" id="clear-filters-btn">Limpiar</button>
            </div>

            <div class="table-container">
              <table id="transactions-table">
                <thead>
                  <tr>
                    <th class="no-wrap">Fecha</th>
                    <th>Descripción</th>
                    <th>Categoría</th>
                    <th>Banco</th>
                    <th class="align-right no-wrap">Monto</th>
                    <th class="align-center no-wrap desktop-actions-col">Acciones</th>
                    <th class="align-center no-wrap mobile-actions-col">Opciones</th>
                  </tr>
                </thead>
                <tbody id="transactions-table-body">
                  <!-- Filas se insertarán aquí -->
                </tbody>
                <tfoot>
                  <tr class="desktop-totals-row">
                    <td colspan="4" class="align-right">Total Ingresos:</td>
                    <td id="total-income-desktop" class="align-right income-text">0.00</td>
                    <td class="desktop-actions-col"></td>
                    <td class="mobile-actions-col"></td>
                  </tr>
                  <tr class="desktop-totals-row">
                    <td colspan="4" class="align-right">Total Gastos:</td>
                    <td id="total-expenses-desktop" class="align-right expense-text">0.00</td>
                    <td class="desktop-actions-col"></td>
                    <td class="mobile-actions-col"></td>
                  </tr>

                  <tr class="mobile-totals-row">
                    <td colspan="2" class="align-right">Total Ingresos:</td>
                    <td id="total-income-mobile" class="align-right income-text">0.00</td>
                    <td class="mobile-actions-col"></td>
                  </tr>
                  <tr class="mobile-totals-row">
                    <td colspan="2" class="align-right">Total Gastos:</td>
                    <td id="total-expenses-mobile" class="align-right expense-text">0.00</td>
                    <td class="mobile-actions-col"></td>
                  </tr>
                </tfoot>
              </table>
              <p id="no-transactions-message" class="no-data-message hidden">
                No hay transacciones registradas.
              </p>
            </div>
          </div>

          <!-- Sección Saldos (Sin cambios de HTML) -->
          <div id="saldos-content" class="tab-pane">
            <h2>Saldos por Cuenta</h2>
            <div id="bank-balances-grid">
              <!-- Cards se insertarán aquí -->
            </div>
            <p id="no-balances-message" class="no-data-message hidden">
              Añade bancos en Configuración y registra transacciones para ver los saldos.
            </p>
          </div>

          <!-- INICIO: NUEVA SECCIÓN PRODUCTOS -->
          <div id="productos-content" class="tab-pane">
            <h2>Gestión de Productos</h2>

            <div class="config-section">
              <h3>Añadir Nuevo Producto</h3>
              <form id="add-product-form" class="simple-add-form">
                <div class="form-group">
                  <label for="new-product-name">Nombre</label>
                  <input
                    type="text"
                    id="new-product-name"
                    placeholder="Nombre del producto"
                    required
                  />
                  <span class="input-error-message" id="new-product-name-error"></span>
                </div>
                <div class="form-group" style="flex-grow: 0.5">
                  <label for="new-product-price">Precio (USD)</label>
                  <input
                    type="number"
                    id="new-product-price"
                    placeholder="0.00"
                    step="0.01"
                    required
                  />
                  <span class="input-error-message" id="new-product-price-error"></span>
                </div>
                <!-- <div class="form-group" style="flex-grow: 0.3">
                  <label for="new-product-stock">Stock</label>
                  <input type="number" id="new-product-stock" placeholder="0" step="1" />
                </div> -->
                <button type="submit" class="btn btn-primary">Añadir Producto</button>
              </form>
            </div>

            <div class="config-section">
              <h3>Mis Productos</h3>
              <ul id="product-list">
                <!-- Los productos se cargarán aquí -->
              </ul>
              <p id="no-products-message" class="no-data-message hidden">
                No hay productos añadidos.
              </p>
            </div>
          </div>
          <!-- FIN: NUEVA SECCIÓN PRODUCTOS -->

          <!-- INICIO: NUEVA SECCIÓN PEDIDOS -->
          <div id="pedidos-content" class="tab-pane">
            <h2>Gestión de Pedidos</h2>

            <div class="form-container-flex">
              <!-- Columna 1: Crear Pedido -->
              <div class="config-section">
                <h3>Crear Nuevo Pedido</h3>
                <form id="create-order-form">
                  <input type="hidden" id="order-id" />
                  <div class="form-group">
                    <label for="order-customer-name">Nombre del Cliente</label>
                    <input type="text" id="order-customer-name" required />
                    <span class="input-error-message" id="order-customer-name-error"></span>
                  </div>
                  <div class="form-group">
                    <label for="order-delivery-date">Fecha de Entrega</label>
                    <input type="date" id="order-delivery-date" required />
                    <span class="input-error-message" id="order-delivery-date-error"></span>
                  </div>

                  <!-- Productos del pedido actual -->
                  <h4>Productos en este Pedido</h4>
                  <ul
                    id="current-order-products-list"
                    class="config-list"
                    style="max-height: 150px"
                  >
                    <!-- Productos seleccionados para el nuevo pedido -->
                  </ul>
                  <p id="no-current-order-products" class="no-data-message" style="padding: 1rem 0">
                    Añade productos al pedido
                  </p>
                  <button
                    type="button"
                    class="btn btn-secondary"
                    id="open-product-select-modal-btn"
                    style="width: 100%; margin: 0.5rem 0"
                  >
                    Añadir/Editar Productos
                  </button>

                  <button type="submit" class="btn btn-primary" style="width: 100%">
                    Guardar Pedido
                  </button>
                </form>
              </div>

              <!-- Columna 2: Pedidos Pendientes -->
              <div class="config-section">
                <h3>Pedidos Pendientes</h3>
                <ul id="orders-list">
                  <!-- Los pedidos se cargarán aquí -->
                </ul>
                <p id="no-orders-message" class="no-data-message hidden">
                  No hay pedidos pendientes.
                </p>
              </div>
            </div>
          </div>
          <!-- FIN: NUEVA SECCIÓN PEDIDOS -->

          <!-- Sección Configuración (Sin cambios de HTML) -->
          <div id="configuracion-content" class="tab-pane">
            <h2>Configuración</h2>

            <div class="config-section">
              <h3>Gestionar Categorías</h3>
              <button class="btn btn-primary" id="open-add-category-modal-btn">
                Añadir Categoría
              </button>
              <ul class="config-list" id="category-list">
                <!-- Categorías se listarán aquí -->
              </ul>
              <p id="no-categories-message" class="no-data-message hidden">
                No hay categorías añadidas.
              </p>
            </div>

            <div class="config-section">
              <h3>Gestionar Bancos/Cuentas</h3>
              <div class="form-group" style="display: flex; gap: 0.5rem; align-items: flex-end">
                <div style="flex-grow: 1">
                  <label for="new-bank-name" style="margin-bottom: 0">Nuevo Banco/Cuenta</label>
                  <input type="text" id="new-bank-name" placeholder="Nombre del banco" />
                  <span class="input-error-message" id="new-bank-name-error"></span>
                </div>
                <button class="btn btn-primary" id="add-bank-btn">Añadir</button>
              </div>
              <ul class="config-list" id="bank-list">
                <!-- Bancos se listarán aquí -->
              </ul>
              <p id="no-banks-message" class="no-data-message hidden">No hay bancos añadidos.</p>
            </div>

            <div class="config-section" style="border-color: var(--danger-color)">
              <h3 style="color: var(--danger-color)">Zona Peligrosa</h3>

              <div class="danger-zone-check-container">
                <input type="checkbox" id="confirm-delete-all-checkbox" />
                <label for="confirm-delete-all-checkbox">
                  Sí, entiendo que esto es permanente.
                </label>
              </div>

              <button class="btn btn-danger" id="delete-all-data-btn" disabled>
                Borrar Todos los Datos de mi Cuenta
              </button>
              <p style="color: var(--dark-gray); font-size: 0.8rem">
                ¡Cuidado! Esto eliminará todas las transacciones, categorías y bancos de tu cuenta
                de forma permanente.
              </p>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Modal Transacción (AHORA SÓLO PARA EDITAR) -->
    <div id="transaction-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modal-title">Editar Transacción</h2>
          <button class="close-btn" id="close-transaction-modal-btn">&times;</button>
        </div>
        <div class="modal-body">
          <form id="transaction-form">
            <input type="hidden" id="transaction-id" />
            <div class="form-group">
              <label for="transaction-type">Tipo</label>
              <select id="transaction-type" required>
                <option value="expense">Gasto</option>
                <option value="income">Ingreso</option>
              </select>
            </div>
            <div class="form-group">
              <label for="transaction-date">Fecha</label>
              <input type="date" id="transaction-date" required />
              <span class="input-error-message" id="transaction-date-error"></span>
            </div>
            <div class="form-group">
              <label for="transaction-description">Descripción</label>
              <input
                type="text"
                id="transaction-description"
                placeholder="Ej: Compra supermercado"
                required
              />
              <span class="input-error-message" id="transaction-description-error"></span>
            </div>
            <div class="form-group">
              <label for="transaction-category">Categoría</label>
              <select id="transaction-category" required>
                <option value="" disabled selected>Selecciona una categoría...</option>
                <!-- Opciones se cargarán dinámicamente -->
              </select>
              <span class="input-error-message" id="transaction-category-error"></span>
            </div>
            <div class="form-group">
              <label for="transaction-bank">Banco/Cuenta</label>
              <select id="transaction-bank" required>
                <option value="" disabled selected>Selecciona un banco...</option>
                <!-- Opciones se cargarán dinámicamente -->
              </select>
              <span class="input-error-message" id="transaction-bank-error"></span>
            </div>
            <div class="form-group">
              <label for="transaction-amount">Monto</label>
              <input
                type="number"
                id="transaction-amount"
                placeholder="0.00"
                step="0.01"
                required
              />
              <span class="input-error-message" id="transaction-amount-error"></span>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="cancel-transaction-btn">
            Cancelar
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            form="transaction-form"
            id="save-transaction-btn"
          >
            Guardar Cambios
            <!-- Texto cambiado -->
          </button>
        </div>
      </div>
    </div>

    <!-- =================================================================== -->
    <!-- --- INICIO: NUEVO MODAL DE CALCULADORA --- -->
    <!-- =================================================================== -->
    <div id="add-registro-calculator-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="calculator-modal-title">Nuevo Registro</h2>
          <button class="close-btn" id="close-calculator-modal-btn">&times;</button>
        </div>
        <!-- Selector de Tipo (Ingreso/Gasto) -->
        <div class="tipo-registro-selector">
          <button class="tipo-registro-btn ingreso" id="calc-btn-ingreso" data-tipo="income">
            Ingreso
          </button>
          <button class="tipo-registro-btn gasto active" id="calc-btn-gasto" data-tipo="expense">
            Gasto
          </button>
        </div>

        <!-- Cuerpo del Formulario (Fecha y Comentario) -->
        <div class="registro-calculator-body">
          <div class="registro-controles-top">
            <input type="date" id="registro-fecha" />
            <button
              class="btn-icon"
              id="registro-comentario-toggle"
              title="Añadir comentario opcional"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="currentColor"
                width="24"
                height="24"
              >
                <path
                  d="M21.99 4c0-1.1-.89-2-1.99-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4-.01-18zM18 14H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"
                />
              </svg>
            </button>
          </div>
          <textarea
            id="registro-comentario-input"
            class="hidden"
            rows="2"
            placeholder="Descripción o comentario opcional..."
          ></textarea>
          <div class="form-group" style="margin-top: 0rem">
            <label for="registro-banco">Banco/Cuenta</label>
            <select id="registro-banco" required>
              <option value="" disabled selected>Selecciona un banco...</option>
            </select>
            <span class="input-error-message" id="registro-banco-error"></span>
          </div>
        </div>

        <!-- Display de la Calculadora -->
        <div id="registro-display-wrapper">
          <div id="registro-display" role="textbox" aria-label="Monto">0</div>
        </div>

        <!-- Teclado de la Calculadora -->
        <div id="calculadora-keypad">
          <button class="calc-btn" data-key="7">7</button>
          <button class="calc-btn" data-key="8">8</button>
          <button class="calc-btn" data-key="9">9</button>
          <button class="calc-btn operator" data-key="+">+</button>

          <button class="calc-btn" data-key="4">4</button>
          <button class="calc-btn" data-key="5">5</button>
          <button class="calc-btn" data-key="6">6</button>
          <button class="calc-btn operator" data-key="-">−</button>

          <button class="calc-btn" data-key="1">1</button>
          <button class="calc-btn" data-key="2">2</button>
          <button class="calc-btn" data-key="3">3</button>
          <button class="calc-btn operator" data-key="*">×</button>

          <button class="calc-btn" data-key=".">.</button>
          <button class="calc-btn" data-key="0">0</button>
          <button class="calc-btn operator" data-key="C">C</button>
          <button class="calc-btn operator" data-key="/">÷</button>

          <button class="calc-btn" id="btn-total">Total</button>
        </div>
      </div>
    </div>
    <!-- =================================================================== -->
    <!-- --- FIN: NUEVO MODAL DE CALCULADORA --- -->
    <!-- =================================================================== -->

    <!-- =================================================================== -->
    <!-- --- INICIO: NUEVO MODAL DE SELECCIÓN DE CATEGORÍA --- -->
    <!-- =================================================================== -->
    <div id="category-select-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="category-select-modal-title">Selecciona una Categoría</h2>
          <button class="close-btn" id="close-category-select-modal-btn">&times;</button>
        </div>
        <div class="modal-body">
          <div id="category-select-grid">
            <!-- Las categorías se cargarán aquí dinámicamente -->
          </div>
        </div>
      </div>
    </div>
    <!-- =================================================================== -->
    <!-- --- FIN: NUEVO MODAL DE SELECCIÓN DE CATEGORÍA --- -->
    <!-- =================================================================== -->

    <!-- Modal Añadir Categoría (con iconos) -->
    <div id="category-icon-modal" class="modal">
      <div class="modal-content" style="max-width: 600px">
        <div class="modal-header">
          <h2>Añadir/Editar Categoría</h2>
          <button class="close-btn" id="close-icon-modal-btn">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="new-category-name-modal">Nombre de la Categoría</label>
            <input type="text" id="new-category-name-modal" placeholder="Ej: Comida, Transporte" />
            <span class="input-error-message" id="new-category-name-modal-error"></span>
          </div>
          <div class="form-group">
            <label>Selecciona un Ícono (Opcional)</label>
            <div id="category-icon-grid">
              <!-- Iconos se cargarán aquí -->
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="cancel-category-btn">Cancelar</button>
          <button type="button" class="btn btn-primary" id="save-new-category-btn">
            Guardar Categoría
          </button>
        </div>
      </div>
    </div>

    <!-- INICIO: NUEVO MODAL SELECCIÓN DE PRODUCTOS -->
    <div id="product-select-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Añadir Productos al Pedido</h2>
          <button class="close-btn" id="close-product-select-modal-btn">&times;</button>
        </div>
        <div class="modal-body">
          <div id="product-select-grid">
            <!-- Productos para seleccionar se cargarán aquí -->
          </div>
          <p id="no-products-to-select-message" class="no-data-message hidden">
            No hay productos definidos. Añade productos en la pestaña 'Productos'.
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="confirm-product-selection-btn">
            Confirmar Productos
          </button>
        </div>
      </div>
    </div>
    <!-- FIN: NUEVO MODAL SELECCIÓN DE PRODUCTOS -->

    <!-- Modal Confirmación -->
    <div id="confirm-modal" class="modal">
      <div class="modal-content" style="max-width: 400px">
        <div class="modal-header">
          <h2 id="confirm-modal-title">Confirmar Acción</h2>
          <button class="close-btn" id="close-confirm-modal-btn">&times;</button>
        </div>
        <div class="modal-body">
          <p id="confirm-modal-message">¿Estás seguro?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="confirm-modal-cancel-btn">
            Cancelar
          </button>
          <button type="button" class="btn btn-danger" id="confirm-modal-confirm-btn">
            Confirmar
          </button>
        </div>
      </div>
    </div>

    <!-- Modal Mensaje Genérico -->
    <div id="message-modal" class="modal">
      <div class="modal-content" style="max-width: 400px">
        <div class="modal-header">
          <h2 id="message-modal-title">Mensaje</h2>
          <button class="close-btn" id="close-message-modal-btn-header">&times;</button>
          <!-- Botón X añadido -->
        </div>
        <div class="modal-body">
          <p id="message-modal-content"></p>
        </div>
        <div class="modal-footer" style="justify-content: center">
          <!-- Centrar botón -->
          <button type="button" class="btn btn-primary" id="message-modal-close-btn">Cerrar</button>
        </div>
      </div>
    </div>

    <!-- Modal de Acciones Móvil -->
    <div id="mobile-actions-modal" class="modal">
      <div class="modal-content" style="max-width: 300px">
        <div class="modal-header">
          <h2 id="mobile-actions-title">Opciones</h2>
          <button class="close-btn" id="close-mobile-actions-modal-btn">&times;</button>
        </div>
        <div class="modal-body" style="display: flex; flex-direction: column; gap: 0.5rem">
          <button class="btn btn-primary" id="mobile-actions-edit-btn">Editar Transacción</button>
          <button class="btn btn-danger" id="mobile-actions-delete-btn">
            Eliminar Transacción
          </button>
        </div>
        <div class="modal-footer" style="padding-top: 0.5rem; border-top: none">
          <button
            type="button"
            class="btn btn-secondary"
            id="mobile-actions-cancel-btn"
            style="width: 100%"
          >
            Cancelar
          </button>
        </div>
      </div>
    </div>

    <div id="bank-select-modal" class="modal">
      <div class="modal-content" style="max-width: 400px">
        <div class="modal-header">
          <h2 id="bank-select-modal-title">Confirmar Venta</h2>
          <button class="close-btn" id="close-bank-select-modal-btn">&times;</button>
        </div>
        <div class="modal-body">
          <p id="bank-select-modal-message">
            Selecciona el banco/cuenta donde se registrará este ingreso:
          </p>
          <div class="form-group">
            <label for="bank-select-dropdown">Banco/Cuenta</label>
            <select id="bank-select-dropdown" required></select>
            <span class="input-error-message" id="bank-select-dropdown-error"></span>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="bank-select-modal-cancel-btn">
            Cancelar
          </button>
          <button type="button" class="btn btn-primary" id="bank-select-modal-confirm-btn">
            Confirmar e Ingresar
          </button>
        </div>
      </div>
    </div>

    <footer>
      <p>&copy; 2025 Gestor Financiero 00012</p>
    </footer>

    <!-- PWA: Registro del Service Worker -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js').catch((err) => console.log('SW error:', err));
        });
      }
    </script>

    <!-- 
      PASO 4: MODIFICAR EL SCRIPT PRINCIPAL
      - Ya no esperamos a 'DOMContentLoaded'. La lógica de Auth se encarga de iniciar.
      - Hemos movido la lógica de inicialización de Firebase AL INICIO del <script type="module"> de arriba.
      - Esta función 'initializeAppLogic' ahora es llamada por el 'vigilante' onAuthStateChanged.
      - Ya no usa localStorage. Usa Firestore.
    -->
    <script type="module">
      // Importamos las herramientas de Firebase que ya se cargaron en el <head>
      // (Esto es una repetición conceptual, el script de arriba ya los puso en el ámbito global del módulo)
      import { getAuth, signOut } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
      import {
        getFirestore,
        doc,
        setDoc,
        addDoc,
        updateDoc,
        deleteDoc,
        onSnapshot,
        collection,
        query,
        getDocs,
        writeBatch,
        serverTimestamp,
      } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

      let uiListenersAttached = false;

      // Esta función AHORA es global dentro del módulo para que el script de arriba pueda llamarla
      window.initializeAppLogic = (auth, db, userId, appId, userEmail) => {
        console.log(`Iniciando lógica de la app para usuario: ${userId}`);

        // --- Definición de Rutas de Firestore ---
        // Estas son las "carpetas" en la nube donde guardaremos los datos DE ESTE USUARIO
        const transactionsCol = collection(db, 'artifacts', appId, 'users', userId, 'transactions');
        // Usamos un solo documento para guardar las configuraciones (bancos y categorías)
        const settingsDoc = doc(db, 'artifacts', appId, 'users', userId, 'appData', 'settings');
        // --- INICIO: NUEVAS COLECCIONES ---
        const productsCol = collection(db, 'artifacts', appId, 'users', userId, 'products');
        const ordersCol = collection(db, 'artifacts', appId, 'users', userId, 'orders');
        // --- FIN: NUEVAS COLECCIONES ---

        // Constantes (igual que antes)
        const DEFAULT_ICON =
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514665/categoria-default_mmpfg4.png';
        const PRESET_ICONS = [
          DEFAULT_ICON,
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514703/vivienda_bsyk94.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/v1756889458/AA7C0FC4-9F29-48D3-BA63-CDF884DA716B_uwkqfp.png', //Saldo
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514702/viajes_duy42o.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514701/transporte_kv5zty.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514700/transferencia-interna_wjuhnq.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514700/telefonia_tfmo9l.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514698/tecnologia_zzpzjl.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514671/entretenimiento2_uxheb0.png', // Entretenimiento
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514695/servicios3_wq8cno.png', // Servicios
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514693/salud_qt9xjk.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514690/ropa_lneukc.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514688/regalos_nlhx7g.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514683/otros_gg6l1e.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514682/ocio_reehch.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514682/mascotas_puroqw.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514678/ingresos_ci7j4p.png', // Ingresos/Sueldo
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514675/impuestos_anoyd1.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514674/gym_lihk76.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514670/educacion_jyz87e.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514668/deudas_jcqhez.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514667/compras_u7wb1e.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514666/comida_ecusji.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/v1761509531/Equipos_ymekb7.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514665/celebraciones_pivh9h.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514663/ahorro_vhwhw7.png',
        ];

        // Estado de la aplicación (AHORA LOCAL, se alimenta de Firestore)
        let localTransactions = [];
        let localCategories = [];
        let localBanks = [];
        // --- INICIO: NUEVOS ESTADOS LOCALES ---
        let localProducts = [];
        let localOrders = [];
        let tempOrderProducts = []; // Para el formulario de nuevo pedido
        // --- FIN: NUEVOS ESTADOS LOCALES ---

        let confirmCallback = null;
        let currentMobileTxId = null;
        let tempOrderIdForBankSelect = null;
        // --- INICIO: NUEVAS VARIABLES GLOBALES PARA EL MODAL DE CALCULADORA ---
        let tempTransactionData = {};
        let currentCalculatorExpression = '0';
        // --- FIN: NUEVAS VARIABLES GLOBALES ---

        // Selectores del DOM (igual que antes)
        const loadingOverlay = document.getElementById('loading-overlay');
        const tabsContainer = document.getElementById('tabs');
        const mainContent = document.getElementById('main-content');
        const userGreeting = document.getElementById('user-greeting'); // Ya existe

        // Modal de Edición (el antiguo)
        const transactionModal = document.getElementById('transaction-modal');
        const transactionForm = document.getElementById('transaction-form');

        const transactionsTableBody = document.getElementById('transactions-table-body');
        const noTransactionsMessage = document.getElementById('no-transactions-message');

        const totalIncomeElDesktop = document.getElementById('total-income-desktop');
        const totalExpensesElDesktop = document.getElementById('total-expenses-desktop');
        const totalIncomeElMobile = document.getElementById('total-income-mobile');
        const totalExpensesElMobile = document.getElementById('total-expenses-mobile');

        const bankBalancesGrid = document.getElementById('bank-balances-grid');
        const noBalancesMessage = document.getElementById('no-balances-message');

        const categoryList = document.getElementById('category-list');
        const noCategoriesMessage = document.getElementById('no-categories-message');
        const bankList = document.getElementById('bank-list');
        const noBanksMessage = document.getElementById('no-banks-message');
        const addBankBtn = document.getElementById('add-bank-btn');
        const newBankNameInput = document.getElementById('new-bank-name');

        const categoryIconModal = document.getElementById('category-icon-modal');
        const categoryIconGrid = document.getElementById('category-icon-grid');
        const newCategoryNameModalInput = document.getElementById('new-category-name-modal');
        const saveNewCategoryBtn = document.getElementById('save-new-category-btn');

        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalTitle = document.getElementById('confirm-modal-title');
        const confirmModalMessage = document.getElementById('confirm-modal-message');
        const confirmModalConfirmBtn = document.getElementById('confirm-modal-confirm-btn');
        const confirmModalCancelBtn = document.getElementById('confirm-modal-cancel-btn');
        const closeConfirmModalBtn = document.getElementById('close-confirm-modal-btn');

        const messageModal = document.getElementById('message-modal');
        const messageModalTitle = document.getElementById('message-modal-title');
        const messageModalContent = document.getElementById('message-modal-content');
        const messageModalCloseBtn = document.getElementById('message-modal-close-btn');
        const closeMessageModalHeaderBtn = document.getElementById(
          'close-message-modal-btn-header',
        );

        const deleteAllDataBtn = document.getElementById('delete-all-data-btn');
        const confirmDeleteAllCheckbox = document.getElementById('confirm-delete-all-checkbox');

        const mobileActionsModal = document.getElementById('mobile-actions-modal');
        const mobileActionsEditBtn = document.getElementById('mobile-actions-edit-btn');
        const mobileActionsDeleteBtn = document.getElementById('mobile-actions-delete-btn');
        // --- INICIO: NUEVOS SELECTORES MODAL SELECCIÓN DE BANCO ---
        const bankSelectModal = document.getElementById('bank-select-modal');
        const bankSelectDropdown = document.getElementById('bank-select-dropdown');
        const bankSelectModalConfirmBtn = document.getElementById('bank-select-modal-confirm-btn');
        const bankSelectModalCancelBtn = document.getElementById('bank-select-modal-cancel-btn');
        const closeBankSelectModalBtn = document.getElementById('close-bank-select-modal-btn');
        const bankSelectDropdownError = document.getElementById('bank-select-dropdown-error');
        // --- FIN: NUEVOS SELECTORES ---
        // --- INICIO: NUEVOS SELECTORES PARA EL MODAL DE CALCULADORA ---
        const calculatorModal = document.getElementById('add-registro-calculator-modal');
        const btnGasto = document.getElementById('calc-btn-gasto');
        const btnIngreso = document.getElementById('calc-btn-ingreso');
        const registroFecha = document.getElementById('registro-fecha');
        const comentarioToggleBtn = document.getElementById('registro-comentario-toggle');
        const comentarioInput = document.getElementById('registro-comentario-input');
        const registroDisplay = document.getElementById('registro-display');
        const keypad = document.getElementById('calculadora-keypad');
        const totalBtn = document.getElementById('btn-total');
        // --- FIN: NUEVOS SELECTORES ---

        // --- INICIO: NUEVOS SELECTORES PARA EL MODAL DE SELECCIÓN DE CATEGORÍA ---
        const categorySelectModal = document.getElementById('category-select-modal');
        const categorySelectGrid = document.getElementById('category-select-grid');
        const closeCategorySelectModalBtn = document.getElementById(
          'close-category-select-modal-btn',
        );
        // --- FIN: NUEVOS SELECTORES ---

        // --- INICIO: NUEVOS SELECTORES DE PRODUCTOS Y PEDIDOS ---
        const addProductForm = document.getElementById('add-product-form');
        const newProductNameInput = document.getElementById('new-product-name');
        const newProductPriceInput = document.getElementById('new-product-price');
        const productList = document.getElementById('product-list');
        const noProductsMessage = document.getElementById('no-products-message');

        const createOrderForm = document.getElementById('create-order-form');
        const orderCustomerNameInput = document.getElementById('order-customer-name');
        const orderDeliveryDateInput = document.getElementById('order-delivery-date');
        const currentOrderProductsList = document.getElementById('current-order-products-list');
        const noCurrentOrderProducts = document.getElementById('no-current-order-products');
        const openProductSelectModalBtn = document.getElementById('open-product-select-modal-btn');
        const ordersList = document.getElementById('orders-list');
        const noOrdersMessage = document.getElementById('no-orders-message');

        const productSelectModal = document.getElementById('product-select-modal');
        const productSelectGrid = document.getElementById('product-select-grid');
        const noProductsToSelectMessage = document.getElementById('no-products-to-select-message');
        const confirmProductSelectionBtn = document.getElementById('confirm-product-selection-btn');
        const closeProductSelectModalBtn = document.getElementById(
          'close-product-select-modal-btn',
        );

        const dashboardNotificaciones = document.getElementById('dashboard-notificaciones');
        const upcomingDeliveriesList = document.getElementById('upcoming-deliveries-list');
        // --- FIN: NUEVOS SELECTORES DE PRODUCTOS Y PEDIDOS ---

        // --- Carga/Guardado de Datos (AHORA CON FIRESTORE) ---

        // Esta función reemplaza a loadDataFromLocalStorage
        function setupFirestoreListeners() {
          console.log('Configurando listeners de Firestore...');
          showLoading();

          // 1. Listener para Transacciones
          // Escucha CUALQUIER cambio en la colección de transacciones
          const qTransactions = query(transactionsCol);
          const unsubscribeTransactions = onSnapshot(
            qTransactions,
            (snapshot) => {
              console.log('Datos de transacciones recibidos de Firestore.');
              localTransactions = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
              renderTransactionsTable(); // Re-renderizar la tabla con los nuevos datos
              renderBankBalances(); // Re-renderizar los saldos
            },
            (error) => {
              console.error('Error al escuchar transacciones:', error);
              showMessageModal('Error de Red', 'No se pudieron cargar las transacciones.', 'error');
            },
          );

          // 2. Listener para Configuraciones (Bancos y Categorías)
          const unsubscribeSettings = onSnapshot(
            settingsDoc,
            async (docSnapshot) => {
              if (docSnapshot.exists()) {
                console.log('Datos de configuración recibidos de Firestore.');
                const settings = docSnapshot.data();
                localCategories =
                  settings.categories && Array.isArray(settings.categories)
                    ? settings.categories
                    : [];
                localBanks = settings.banks && Array.isArray(settings.banks) ? settings.banks : [];

                // Renderizar UI con los datos de configuración
                renderConfigurationLists();
                populateModalDropdowns();
                renderBankBalances(); // Re-renderizar saldos por si cambiaron los bancos

                // --- INICIO DE LA CORRECCIÓN ---
                // Volvemos a renderizar la tabla de transacciones
                // por si este listener se ejecutó DESPUÉS que el de transacciones.
                // Esto asegura que los iconos de categoría en la tabla estén actualizados.
                renderTransactionsTable();
                // --- FIN DE LA CORRECCIÓN ---
              } else {
                // --- ¡NUEVO USUARIO! ---
                // El documento de settings no existe, así que lo creamos con valores por defecto.
                console.log('Documento de settings no existe. Creando uno nuevo para el usuario.');
                const defaultCategories = [
                  {
                    name: 'Compras',
                    icon: 'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514667/compras_u7wb1e.png',
                  },
                  {
                    name: 'Transporte',
                    icon: 'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514701/transporte_kv5zty.png',
                  },
                  {
                    name: 'Local',
                    icon: 'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514703/vivienda_bsyk94.png',
                  },
                  {
                    name: 'Ventas',
                    icon: 'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514678/ingresos_ci7j4p.png',
                  },
                  {
                    name: 'Equipos',
                    icon: 'https://res.cloudinary.com/datwdagbf/image/upload/v1761509531/Equipos_ymekb7.png',
                  },
                  {
                    name: 'Servicios',
                    icon: 'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514695/servicios3_wq8cno.png',
                  },
                ];
                const defaultBanks = ['Efectivo', 'Cuenta Principal'];

                try {
                  await setDoc(settingsDoc, {
                    categories: defaultCategories,
                    banks: defaultBanks,
                  });
                  console.log('Settings por defecto guardados para nuevo usuario.');
                  // El 'onSnapshot' se disparará de nuevo con los datos que acabamos de guardar
                } catch (error) {
                  console.error('Error guardando settings por defecto:', error);
                }
              }
              hideLoading(); // Ocultar carga después de recibir los settings
            },
            (error) => {
              console.error('Error al escuchar settings:', error);
              showMessageModal(
                'Error de Red',
                'No se pudieron cargar las configuraciones.',
                'error',
              );
              hideLoading();
            },
          );

          // --- INICIO: NUEVOS LISTENERS (PRODUCTOS Y PEDIDOS) ---

          // 3. Listener para Productos
          const qProducts = query(productsCol);
          const unsubscribeProducts = onSnapshot(
            qProducts,
            (snapshot) => {
              console.log('Datos de productos recibidos de Firestore.');
              localProducts = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
              renderProductsList(); // Renderizar la lista de productos
            },
            (error) => {
              console.error('Error al escuchar productos:', error);
              showMessageModal('Error de Red', 'No se pudieron cargar los productos.', 'error');
            },
          );

          // 4. Listener para Pedidos
          const qOrders = query(ordersCol);
          const unsubscribeOrders = onSnapshot(
            qOrders,
            (snapshot) => {
              console.log('Datos de pedidos recibidos de Firestore.');
              localOrders = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
              renderOrdersList(); // Renderizar la lista de pedidos
              renderUpcomingDeliveries(); // Actualizar el dashboard
            },
            (error) => {
              console.error('Error al escuchar pedidos:', error);
              showMessageModal('Error de Red', 'No se pudieron cargar los pedidos.', 'error');
            },
          );

          // --- FIN: NUEVOS LISTENERS ---

          // Guardamos las funciones 'unsubscribe' para llamarlas al hacer logout
          // (Esto es una variable global definida en el script de Auth)
          window.firestoreListeners = [
            unsubscribeTransactions,
            unsubscribeSettings,
            unsubscribeProducts, // AÑADIDO
            unsubscribeOrders, // AÑADIDO
          ];
        }

        // Ya no necesitamos saveDataToLocalStorage.
        // Las funciones ahora escribirán directamente en Firestore.

        // --- Lógica de Inicialización (MODIFICADA) ---
        function initAppWithFirebase() {
          // Actualizamos el saludo con el email del usuario
          userGreeting.textContent = `Bienvenido, ${userEmail || 'Usuario'}`;

          setupFirestoreListeners(); // Cargar datos de Firestore

          // --- INICIO DE LA CORRECCIÓN 2 ---
          // Comprobamos si los listeners de la UI ya se han configurado.
          // Esto evita que se añadan múltiples listeners al mismo botón
          // si el usuario hace logout y login de nuevo.
          if (!uiListenersAttached) {
            console.log('Configurando listeners de UI por primera vez.');
            setupEventListeners(); // Configurar listeners de UI
            uiListenersAttached = true; // Marcamos que ya están configurados
          } else {
            console.log('Listeners de UI ya están configurados, omitiendo.');
          }
          // --- FIN DE LA CORRECCIÓN 2 ---

          switchTab('registros'); // Mostrar la primera pestaña
        }
        initAppWithFirebase(); // Llamar a la inicialización

        // --- Manejo de Pestañas (sin cambios) ---
        function switchTab(tabId) {
          mainContent
            .querySelectorAll('.tab-pane')
            .forEach((pane) => pane.classList.remove('active'));
          tabsContainer
            .querySelectorAll('.tab-button')
            .forEach((button) => button.classList.remove('active'));
          const activePane = document.getElementById(`${tabId}-content`);
          if (activePane) activePane.classList.add('active');
          const activeButton = tabsContainer.querySelector(`button[data-tab="${tabId}"]`);
          if (activeButton) activeButton.classList.add('active');

          // Ya no necesitamos renderizar aquí, los listeners lo hacen en tiempo real
        }

        // --- Lógica de Registros (MODIFICADA) ---
        function renderTransactionsTable() {
          transactionsTableBody.innerHTML = '';

          // LÓGICA DE FILTRADO (igual que antes)
          const filterBank = document.getElementById('filter-bank').value;
          const filterMonth = document.getElementById('filter-month').value;

          // Usamos 'localTransactions' en lugar de 'appState.transactions'
          let filteredTransactions = localTransactions.filter((tx) => {
            if (filterBank !== 'all' && tx.bank !== filterBank) return false;
            if (filterMonth) {
              if (!tx.date || !tx.date.startsWith(filterMonth)) return false;
            }
            return true;
          });

          // Ordenar
          const sortedTransactions = filteredTransactions.sort(
            (a, b) => new Date(a.date + 'T00:00:00') - new Date(b.date + 'T00:00:00'),
          );

          if (sortedTransactions.length === 0) {
            // Usamos 'localTransactions' para el mensaje
            if (localTransactions.length > 0) {
              noTransactionsMessage.textContent =
                'No hay transacciones que coincidan con los filtros.';
            } else {
              noTransactionsMessage.textContent = 'No hay transacciones registradas.';
            }
            noTransactionsMessage.classList.remove('hidden');
            // MODIFICADO: No ocultar la tabla, sino el tbody
            transactionsTableBody.parentElement.style.display = 'none';
          } else {
            noTransactionsMessage.classList.add('hidden');
            transactionsTableBody.parentElement.style.display = '';
            sortedTransactions.forEach((tx) => {
              const row = transactionsTableBody.insertRow();
              row.dataset.id = tx.id; // ¡Importante! Usamos el ID de Firestore
              // El HTML de la fila es el mismo
              row.innerHTML = `
                             <td class="no-wrap">
                                 <span class="full-date">${formatDate(tx.date)}</span>
                                 <span class="mobile-date">${formatDateMobile(tx.date)}</span>
                             </td>
                             <td>${tx.description || ''}</td>
                             <td>
                                <div class="category-cell-content">
                                    ${getCategoryDisplay(tx.category || 'Sin Categoría')}
                                    
                                    <button class="info-btn" type="button" data-description="${
                                      tx.description
                                        ? tx.description.replace(/"/g, '&quot;')
                                        : 'Sin descripción'
                                    }">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 14px; height: 14px;">
                                            <path d="M11 17h2v-6h-2v6zm1-15C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM11 9h2V7h-2v2z"/>
                                        </svg>
                                    </button>
                                </div>
                            </td>
                             <td>${tx.bank || ''}</td>
                             <td class="align-right no-wrap ${
                               tx.type === 'income' ? 'income-text' : 'expense-text'
                             }">${formatCurrency(tx.amount || 0)}</td>
                             <td class="align-center no-wrap desktop-actions-col">
                                 <button class="btn-icon edit-btn" title="Editar" data-id="${
                                   tx.id
                                 }">
                                     <svg viewBox="0 0 24 24" fill="currentColor"><path d="M17.293 2.293a1 1 0 0 1 1.414 0l3 3a1 1 0 0 1 0 1.414l-13 13A1 1 0 0 1 7.414 21H4a1 1 0 0 1-1-1v-3.414a1 1 0 0 1 .293-.707l13-13zm-.586 1.707L5 15.586V19h3.414l11.293-11.293-3.414-3.414zM19 7.414l-3.414-3.414 1.293-1.293 3.414 3.414-1.293 1.293z"></path></svg>
                                 </button>
                                 <button class="btn-icon delete-btn" title="Eliminar" data-id="${
                                   tx.id
                                 }">
                                      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></svg>
                                 </button>
                             </td>
                             <td class="align-center no-wrap mobile-actions-col">
                                <button class="btn-icon mobile-options-btn" title="Opciones" data-id="${
                                  tx.id
                                }">
                                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path></svg>
                                </button>
                             </td>
                         `;
              // Event listeners (apuntan a las nuevas funciones de Firestore)
              row
                .querySelector('.edit-btn')
                .addEventListener('click', (e) => openTransactionModal(e.currentTarget.dataset.id));
              row
                .querySelector('.delete-btn')
                .addEventListener('click', (e) => deleteTransaction(e.currentTarget.dataset.id));
              row
                .querySelector('.mobile-options-btn')
                .addEventListener('click', (e) =>
                  openMobileActionsModal(e.currentTarget.dataset.id),
                );
            });
          }
          calculateAndRenderTotals(sortedTransactions);
        }

        // MODIFICADO: Aceptar array de transacciones
        function calculateAndRenderTotals(transactionsToSum) {
          // Ya no usamos el estado global, sino las transacciones que nos pasan
          const transactions = transactionsToSum || [];

          const income = transactions
            .filter((tx) => tx.type === 'income')
            .reduce((sum, tx) => sum + (tx.amount || 0), 0);
          const expenses = transactions
            .filter((tx) => tx.type === 'expense')
            .reduce((sum, tx) => sum + (tx.amount || 0), 0);

          totalIncomeElDesktop.textContent = formatCurrency(income);
          totalExpensesElDesktop.textContent = formatCurrency(expenses);
          totalIncomeElMobile.textContent = formatCurrency(income);
          totalExpensesElMobile.textContent = formatCurrency(expenses);
        }

        // MODIFICADO: Rellenar modal (PARA EDICIÓN)
        function openTransactionModal(transactionId = null) {
          // ESTA FUNCIÓN AHORA SÓLO SE USA PARA EDITAR
          transactionForm.reset();
          clearValidationErrors();
          // populateModalDropdowns(); // No es necesario, los dropdowns ya están poblados por el listener

          const modalTitle = document.getElementById('modal-title');
          const idInput = document.getElementById('transaction-id');
          const typeSelect = document.getElementById('transaction-type');
          const dateInput = document.getElementById('transaction-date');
          const descriptionInput = document.getElementById('transaction-description');
          const categorySelect = document.getElementById('transaction-category');
          const bankSelect = document.getElementById('transaction-bank');
          const amountInput = document.getElementById('transaction-amount');

          if (transactionId) {
            // Buscamos en 'localTransactions'
            const tx = localTransactions.find((t) => t.id === transactionId);
            if (tx) {
              modalTitle.textContent = 'Editar Transacción';
              idInput.value = tx.id;
              typeSelect.value = tx.type;
              dateInput.value = tx.date;
              descriptionInput.value = tx.description;
              categorySelect.value = tx.category;
              bankSelect.value = tx.bank;
              amountInput.value = tx.amount;
            } else {
              console.error('Transacción no encontrada para editar:', transactionId);
              showMessageModal('Error', 'No se encontró la transacción para editar.', 'error');
              return;
            }
          } else {
            // Esta parte ya no debería llamarse, pero se deja por seguridad
            modalTitle.textContent = 'Añadir Transacción';
            idInput.value = '';
            dateInput.valueAsDate = new Date();
            categorySelect.selectedIndex = 0;
            bankSelect.selectedIndex = 0;
          }
          transactionModal.classList.add('active');
        }

        function closeTransactionModal() {
          transactionModal.classList.remove('active');
        }

        // MODIFICADO: Guardar en Firestore (SÓLO EDICIÓN)
        async function handleTransactionFormSubmit(event) {
          event.preventDefault();
          if (!validateTransactionForm()) return;

          const id = document.getElementById('transaction-id').value;
          // Si no hay ID, es un error, esta forma ya no es para añadir
          if (!id) {
            console.error('Se intentó añadir desde el modal de edición.');
            closeTransactionModal();
            return;
          }

          const transactionData = {
            type: document.getElementById('transaction-type').value,
            date: document.getElementById('transaction-date').value,
            description: toTitleCase(
              document.getElementById('transaction-description').value.trim(),
            ),
            category: document.getElementById('transaction-category').value,
            bank: document.getElementById('transaction-bank').value,
            amount: parseFloat(document.getElementById('transaction-amount').value),
          };

          const saveBtn = document.getElementById('save-transaction-btn');
          saveBtn.disabled = true;
          showLoading();

          try {
            // Editar (Update)
            const txDoc = doc(db, 'artifacts', appId, 'users', userId, 'transactions', id);
            await updateDoc(txDoc, transactionData);
            showToast('Transacción actualizada');
            // NO necesitamos llamar a renderTransactionsTable.
            // El 'onSnapshot' lo hará automáticamente.
            closeTransactionModal();
          } catch (error) {
            console.error('Error guardando transacción en Firestore:', error);
            showMessageModal('Error', 'No se pudo guardar la transacción.', 'error');
          } finally {
            saveBtn.disabled = false;
            hideLoading();
          }
        }

        // validateTransactionForm (sin cambios)
        function validateTransactionForm() {
          clearValidationErrors();
          let isValid = true;
          if (
            !validateRequired(
              document.getElementById('transaction-description'),
              document.getElementById('transaction-description-error'),
              'La descripción es obligatoria.',
            )
          )
            isValid = false;
          if (
            !validateRequired(
              document.getElementById('transaction-category'),
              document.getElementById('transaction-category-error'),
              'Selecciona una categoría.',
            )
          )
            isValid = false;
          if (
            !validateRequired(
              document.getElementById('transaction-bank'),
              document.getElementById('transaction-bank-error'),
              'Selecciona un banco/cuenta.',
            )
          )
            isValid = false;
          if (
            !validatePositiveNumber(
              document.getElementById('transaction-amount'),
              document.getElementById('transaction-amount-error'),
              'El monto debe ser un número positivo.',
            )
          )
            isValid = false;
          if (
            !validateRequired(
              document.getElementById('transaction-date'),
              document.getElementById('transaction-date-error'),
              'La fecha es obligatoria.',
            )
          )
            isValid = false;
          return isValid;
        }

        // MODIFICADO: Borrar de Firestore
        function deleteTransaction(transactionId) {
          openConfirmModal(
            'Eliminar Transacción',
            '¿Estás seguro de que quieres eliminar esta transacción?',
            async () => {
              showLoading();
              try {
                const txDoc = doc(
                  db,
                  'artifacts',
                  appId,
                  'users',
                  userId,
                  'transactions',
                  transactionId,
                );
                await deleteDoc(txDoc);
                showToast('Transacción eliminada');
                // onSnapshot se encargará de actualizar la UI
              } catch (error) {
                console.error('Error borrando transacción:', error);
                showMessageModal('Error', 'No se pudo eliminar la transacción.', 'error');
              } finally {
                hideLoading();
              }
            },
          );
        }

        // --- Lógica de Saldos (MODIFICADA) ---
        function renderBankBalances() {
          bankBalancesGrid.innerHTML = '';
          const balances = {};
          // Usamos 'localBanks' y 'localTransactions'
          localBanks.forEach((bank) => {
            balances[bank] = 0;
          });
          localTransactions.forEach((tx) => {
            if (tx.bank && balances.hasOwnProperty(tx.bank)) {
              balances[tx.bank] += (tx.type === 'income' ? 1 : -1) * (tx.amount || 0);
            }
          });

          if (localBanks.length === 0 && localTransactions.length === 0) {
            noBalancesMessage.classList.remove('hidden');
          } else if (localBanks.length === 0 && localTransactions.length > 0) {
            noBalancesMessage.textContent =
              'Añade bancos en Configuración para ver los saldos detallados.';
            noBalancesMessage.classList.remove('hidden');
          } else {
            noBalancesMessage.classList.add('hidden');
            const sortedBanks = Object.keys(balances).sort();
            sortedBanks.forEach((bankName) => {
              const balance = balances[bankName];
              const card = document.createElement('div');
              card.className = 'balance-card';
              card.innerHTML = `
                             <h3>${bankName}</h3>
                             <p class="balance-amount ${
                               balance >= 0 ? 'balance-positive' : 'balance-negative'
                             }">
                                 ${formatCurrency(balance)}
                             </p>
                         `;
              bankBalancesGrid.appendChild(card);
            });
          }
        }

        // --- Lógica de Configuración (MODIFICADA) ---
        function renderConfigurationLists() {
          // Categorías (usa 'localCategories')
          categoryList.innerHTML = '';
          if (localCategories.length === 0) {
            noCategoriesMessage.classList.remove('hidden');
          } else {
            noCategoriesMessage.classList.add('hidden');
            // Ordenamos alfabéticamente para mostrar
            const sortedCategories = [...localCategories].sort((a, b) =>
              a.name.localeCompare(b.name),
            );

            sortedCategories.forEach((cat) => {
              const li = document.createElement('li');
              li.dataset.name = cat.name;
              li.innerHTML = `
                            <span class="config-item-content">
                                <img src="${
                                  cat.icon || DEFAULT_ICON
                                }" alt="" class="category-icon-small">
                                ${cat.name}
                            </span>
                             <button class="btn-icon delete-category-btn" title="Eliminar" data-name="${
                               cat.name
                             }">
                                 <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></svg>
                             </button>
                        `;
              li.querySelector('.delete-category-btn').addEventListener('click', (e) =>
                deleteCategory(e.currentTarget.dataset.name),
              );
              categoryList.appendChild(li);
            });
          }

          // Bancos (usa 'localBanks')
          bankList.innerHTML = '';
          if (localBanks.length === 0) {
            noBanksMessage.classList.remove('hidden');
          } else {
            noBanksMessage.classList.add('hidden');
            // Ordenamos alfabéticamente para mostrar
            const sortedBanks = [...localBanks].sort();

            sortedBanks.forEach((bank) => {
              const li = document.createElement('li');
              li.dataset.name = bank;
              li.innerHTML = `
                            <span class="config-item-content">${bank}</span>
                             <button class="btn-icon delete-bank-btn" title="Eliminar" data-name="${bank}">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></svg>
                             </button>
                        `;
              li.querySelector('.delete-bank-btn').addEventListener('click', (e) =>
                deleteBank(e.currentTarget.dataset.name),
              );
              bankList.appendChild(li);
            });
          }
        }

        // open/close/render Modales (sin cambios)
        function openAddCategoryModal() {
          newCategoryNameModalInput.value = '';
          clearValidationErrors();
          renderIconGrid();
          categoryIconModal.classList.add('active');
        }
        function closeAddCategoryModal() {
          categoryIconModal.classList.remove('active');
        }
        function renderIconGrid() {
          categoryIconGrid.innerHTML = '';
          PRESET_ICONS.forEach((iconUrl) => {
            const option = document.createElement('div');
            option.className = 'icon-option';
            option.dataset.icon = iconUrl;
            option.innerHTML = `<img src="${iconUrl}" alt="Icono">`;
            if (iconUrl === DEFAULT_ICON) {
              option.classList.add('selected');
            }
            option.addEventListener('click', () => {
              categoryIconGrid.querySelector('.icon-option.selected')?.classList.remove('selected');
              option.classList.add('selected');
            });
            categoryIconGrid.appendChild(option);
          });
        }

        // MODIFICADO: Guardar Categoría en Firestore
        async function handleSaveCategory() {
          clearValidationErrors();
          const name = newCategoryNameModalInput.value.trim();
          const selectedIconEl = categoryIconGrid.querySelector('.icon-option.selected');
          const icon = selectedIconEl ? selectedIconEl.dataset.icon : DEFAULT_ICON;

          if (
            !validateRequired(
              newCategoryNameModalInput,
              document.getElementById('new-category-name-modal-error'),
              'El nombre es obligatorio.',
            )
          )
            return;

          // Comprobamos en 'localCategories'
          if (localCategories.some((cat) => cat.name.toLowerCase() === name.toLowerCase())) {
            showError(
              document.getElementById('new-category-name-modal-error'),
              'Esta categoría ya existe.',
            );
            return;
          }

          const newCategory = { name: toTitleCase(name), icon: icon };
          // Creamos la nueva lista
          const newCategoriesList = [...localCategories, newCategory];

          showLoading();
          try {
            // Actualizamos el documento 'settings' en Firestore
            await updateDoc(settingsDoc, { categories: newCategoriesList });
            showToast('Categoría añadida');
            closeAddCategoryModal();
            // onSnapshot se encargará de actualizar la UI
          } catch (error) {
            console.error('Error al guardar categoría:', error);
            showMessageModal('Error', 'No se pudo guardar la categoría.', 'error');
          } finally {
            hideLoading();
          }
        }

        // MODIFICADO: Borrar Categoría de Firestore
        function deleteCategory(categoryName) {
          openConfirmModal(
            'Eliminar Categoría',
            `¿Seguro que quieres eliminar la categoría "${categoryName}"?`,
            async () => {
              // Creamos la nueva lista filtrada
              const newCategoriesList = localCategories.filter((cat) => cat.name !== categoryName);

              showLoading();
              try {
                // Actualizamos el documento 'settings' en Firestore
                await updateDoc(settingsDoc, { categories: newCategoriesList });
                showToast('Categoría eliminada');
                // onSnapshot se encargará de actualizar la UI
              } catch (error) {
                console.error('Error al borrar categoría:', error);
                showMessageModal('Error', 'No se pudo eliminar la categoría.', 'error');
              } finally {
                hideLoading();
              }
            },
          );
        }

        // MODIFICADO: Añadir Banco en Firestore
        async function handleAddBank() {
          clearValidationErrors();
          const name = newBankNameInput.value.trim();
          if (
            !validateRequired(
              newBankNameInput,
              document.getElementById('new-bank-name-error'),
              'El nombre es obligatorio.',
            )
          )
            return;

          // Comprobamos en 'localBanks'
          if (localBanks.some((b) => b.toLowerCase() === name.toLowerCase())) {
            showError(
              document.getElementById('new-bank-name-error'),
              'Este banco/cuenta ya existe.',
            );
            return;
          }

          // Creamos la nueva lista
          const newBanksList = [...localBanks, toTitleCase(name)];

          showLoading();
          try {
            // Actualizamos el documento 'settings' en Firestore
            await updateDoc(settingsDoc, { banks: newBanksList });
            showToast('Banco/Cuenta añadido');
            newBankNameInput.value = '';
            // onSnapshot se encargará de actualizar la UI
          } catch (error) {
            console.error('Error al añadir banco:', error);
            showMessageModal('Error', 'No se pudo añadir el banco.', 'error');
          } finally {
            hideLoading();
          }
        }

        // MODIFICADO: Borrar Banco de Firestore
        function deleteBank(bankName) {
          openConfirmModal(
            'Eliminar Banco/Cuenta',
            `¿Seguro que quieres eliminar "${bankName}"?`,
            async () => {
              // Creamos la nueva lista
              const newBanksList = localBanks.filter((b) => b !== bankName);

              showLoading();
              try {
                // Actualizamos el documento 'settings' en Firestore
                await updateDoc(settingsDoc, { banks: newBanksList });
                showToast('Banco/Cuenta eliminado');
                // onSnapshot se encargará de actualizar la UI
              } catch (error) {
                console.error('Error al borrar banco:', error);
                showMessageModal('Error', 'No se pudo eliminar el banco.', 'error');
              } finally {
                hideLoading();
              }
            },
          );
        }

        // --- FUNCIÓN: Borrar todos los datos (MODIFICADA para Firestore) ---
        async function deleteAllData() {
          openConfirmModal(
            'Borrar Todos los Datos',
            '¡ADVERTENCIA! Esto eliminará permanentemente TODAS las transacciones, categorías, bancos, productos y pedidos de tu cuenta. Esta acción no se puede deshacer. ¿Continuar?',
            async () => {
              showLoading();
              try {
                // Para borrar todos los datos, borramos las transacciones (en lote)
                // y reseteamos el documento de settings.
                // AHORA TAMBIÉN BORRAMOS PRODUCTOS Y PEDIDOS

                const batch = writeBatch(db);

                // 1. Borrar todas las transacciones
                const qTx = query(transactionsCol);
                const txSnapshot = await getDocs(qTx);
                txSnapshot.forEach((doc) => batch.delete(doc.ref));

                // 2. Borrar todos los productos
                const qProd = query(productsCol);
                const prodSnapshot = await getDocs(qProd);
                prodSnapshot.forEach((doc) => batch.delete(doc.ref));

                // 3. Borrar todos los pedidos
                const qOrd = query(ordersCol);
                const ordSnapshot = await getDocs(qOrd);
                ordSnapshot.forEach((doc) => batch.delete(doc.ref));

                // 4. Resetear (o borrar) el documento de settings
                const defaultCategories = [
                  {
                    name: 'Compras',
                    icon: 'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514667/compras_u7wb1e.png',
                  },
                  {
                    name: 'Transporte',
                    icon: 'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514701/transporte_kv5zty.png',
                  },
                  {
                    name: 'Local',
                    icon: 'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514703/vivienda_bsyk94.png',
                  },
                  {
                    name: 'Ventas',
                    icon: 'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514678/ingresos_ci7j4p.png',
                  },
                  {
                    name: 'Equipos',
                    icon: 'https://res.cloudinary.com/datwdagbf/image/upload/v1761509531/Equipos_ymekb7.png',
                  },
                  {
                    name: 'Servicios',
                    icon: 'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514695/servicios3_wq8cno.png',
                  },
                ];
                const defaultBanks = ['Efectivo'];

                batch.set(settingsDoc, {
                  // Usamos set (sobrescribir) en lugar de update
                  categories: defaultCategories,
                  banks: defaultBanks,
                });

                // 5. Ejecutar el lote
                await batch.commit();

                // onSnapshot se encargará de actualizar la UI a los valores por defecto

                // Resetear checkbox y deshabilitar botón
                if (confirmDeleteAllCheckbox) {
                  confirmDeleteAllCheckbox.checked = false;
                }
                if (deleteAllDataBtn) {
                  deleteAllDataBtn.disabled = true;
                }

                showMessageModal(
                  'Datos Eliminados',
                  'Toda la información de tu cuenta ha sido reseteada.',
                  'success',
                );
              } catch (error) {
                console.error('Error al borrar todos los datos:', error);
                showMessageModal('Error', 'No se pudieron borrar los datos.', 'error');
              } finally {
                hideLoading();
              }
            },
          );
        }

        // --- INICIO: LÓGICA DE PRODUCTOS Y PEDIDOS ---

        // --- PRODUCTOS ---

        /**
         * Renderiza la lista de productos en la pestaña 'Productos'.
         */
        function renderProductsList() {
          productList.innerHTML = '';
          if (localProducts.length === 0) {
            noProductsMessage.classList.remove('hidden');
          } else {
            noProductsMessage.classList.add('hidden');
            const sortedProducts = [...localProducts].sort((a, b) => a.name.localeCompare(b.name));

            sortedProducts.forEach((product) => {
              const card = document.createElement('li');
              card.className = 'product-card';
              card.innerHTML = `
              <div class="product-info">
                <h4>${product.name}</h4>
                <!-- <p>Stock: ${product.stock || 0}</p> -->
              </div>
              <span class="product-price">${formatCurrency(product.price)}</span>
              <div class="product-actions">
                <button class="btn-icon delete-product-btn" title="Eliminar Producto" data-id="${
                  product.id
                }">
                  <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></svg>
                </button>
              </div>
            `;
              card
                .querySelector('.delete-product-btn')
                .addEventListener('click', () => deleteProduct(product.id, product.name));
              productList.appendChild(card);
            });
          }
        }

        /**
         * Maneja el envío del formulario para añadir un nuevo producto.
         */
        async function handleAddProduct(event) {
          event.preventDefault();
          clearValidationErrors();
          let isValid = true;
          const name = newProductNameInput.value.trim();
          const price = parseFloat(newProductPriceInput.value);

          if (
            !validateRequired(
              newProductNameInput,
              document.getElementById('new-product-name-error'),
              'El nombre es obligatorio.',
            )
          )
            isValid = false;
          if (
            !validatePositiveNumber(
              newProductPriceInput,
              document.getElementById('new-product-price-error'),
              'El precio debe ser un número positivo.',
            )
          )
            isValid = false;

          if (!isValid) return;

          const newProduct = {
            name: toTitleCase(name),
            price: price,
            // stock: parseInt(document.getElementById('new-product-stock').value) || 0
          };

          showLoading();
          try {
            await addDoc(productsCol, newProduct);
            showToast('Producto añadido');
            addProductForm.reset();
            // onSnapshot se encargará de actualizar la UI
          } catch (error) {
            console.error('Error añadiendo producto:', error);
            showMessageModal('Error', 'No se pudo añadir el producto.', 'error');
          } finally {
            hideLoading();
          }
        }

        /**
         * Elimina un producto de Firestore.
         */
        function deleteProduct(productId, productName) {
          openConfirmModal(
            'Eliminar Producto',
            `¿Seguro que quieres eliminar "${productName}"?`,
            async () => {
              showLoading();
              try {
                const prodDoc = doc(db, 'artifacts', appId, 'users', userId, 'products', productId);
                await deleteDoc(prodDoc);
                showToast('Producto eliminado');
                // onSnapshot se encargará de actualizar la UI
              } catch (error) {
                console.error('Error borrando producto:', error);
                showMessageModal('Error', 'No se pudo eliminar el producto.', 'error');
              } finally {
                hideLoading();
              }
            },
          );
        }

        /**
         * Elimina un pedido de Firestore.
         */
        function deleteOrder(orderId, customerName) {
          openConfirmModal(
            'Eliminar Pedido',
            `¿Seguro que quieres eliminar el pedido de "${customerName}"? Esta acción no se puede deshacer.`,
            async () => {
              showLoading();
              try {
                const orderDoc = doc(db, 'artifacts', appId, 'users', userId, 'orders', orderId);
                await deleteDoc(orderDoc);
                showToast('Pedido eliminado');
                // onSnapshot se encargará de actualizar la UI
              } catch (error) {
                console.error('Error borrando pedido:', error);
                showMessageModal('Error', 'No se pudo eliminar el pedido.', 'error');
              } finally {
                hideLoading();
              }
            },
          );
        }

        // --- INICIO: NUEVAS FUNCIONES PARA EL MODAL DE BANCO ---
        /**
         * Abre el modal de selección de banco y guarda el ID del pedido temporalmente.
         */
        function openBankSelectModal(orderId) {
          const order = localOrders.find((o) => o.id === orderId);
          if (!order) {
            console.error('Pedido no encontrado');
            // Revertir el checkbox si el pedido no se encuentra
            const checkbox = document.getElementById(`confirm-${orderId}`);
            if (checkbox) checkbox.checked = false;
            return;
          }

          // Guardar el ID del pedido temporalmente
          tempOrderIdForBankSelect = orderId;

          // Poblar el desplegable de bancos
          populateSelectWithOptions(
            'bank-select-dropdown',
            localBanks,
            null,
            null,
            'Selecciona un banco...',
            '',
            true,
          );

          // Intentar pre-seleccionar 'Efectivo' si existe
          if (localBanks.includes('Efectivo')) {
            bankSelectDropdown.value = 'Efectivo';
          }

          // Limpiar errores previos
          hideError(bankSelectDropdownError);

          // Mostrar el modal
          bankSelectModal.classList.add('active');
        }

        /**
         * Cierra el modal de banco y desmarca el checkbox (si el usuario canceló).
         */
        function closeBankSelectModal() {
          if (tempOrderIdForBankSelect) {
            // Si el usuario cancela, buscamos el checkbox original y lo desmarcamos
            const checkbox = document.getElementById(`confirm-${tempOrderIdForBankSelect}`);
            if (checkbox) checkbox.checked = false;
          }
          bankSelectModal.classList.remove('active');
          tempOrderIdForBankSelect = null; // Limpiar el ID temporal
        }

        /**
         * Se ejecuta al confirmar el banco. Valida y llama a handleConfirmDelivery.
         */
        async function handleBankSelectionConfirm() {
          // 1. Validar que se seleccionó un banco
          if (
            !validateRequired(
              bankSelectDropdown,
              bankSelectDropdownError,
              'Debes seleccionar un banco.',
            )
          ) {
            return; // Detener si no es válido
          }

          const selectedBank = bankSelectDropdown.value;
          const orderId = tempOrderIdForBankSelect;

          if (!orderId) {
            console.error('Error: Se perdió el ID del pedido.');
            closeBankSelectModal();
            return;
          }

          // 2. Cerrar el modal y limpiar el ID temporal
          bankSelectModal.classList.remove('active');
          tempOrderIdForBankSelect = null;

          // 3. Llamar a la función de confirmación (que ahora modificaremos)
          await handleConfirmDelivery(orderId, selectedBank);
        }

        // --- FIN: NUEVAS FUNCIONES PARA EL MODAL DE BANCO ---

        // --- PEDIDOS ---
        /**
         * Renderiza la lista de pedidos pendientes.
         */
        function renderOrdersList() {
          ordersList.innerHTML = '';
          const pendingOrders = localOrders
            .filter((order) => order.status === 'pending')
            .sort((a, b) => new Date(a.deliveryDate) - new Date(b.deliveryDate));

          if (pendingOrders.length === 0) {
            noOrdersMessage.classList.remove('hidden');
          } else {
            noOrdersMessage.classList.add('hidden');
            pendingOrders.forEach((order) => {
              const card = document.createElement('li');
              card.className = 'order-card';
              card.dataset.id = order.id;

              const productsHtml = order.products
                .map((p) => `<li>${p.quantity} x ${p.name} (${formatCurrency(p.price)})</li>`)
                .join('');

              // --- INICIO: HTML MODIFICADO PARA AÑADIR BOTÓN ---
              card.innerHTML = `
              <div class="order-card-header">
                <div>
                  <h3>${order.customerName}</h3>
                  <span>Entrega: ${formatDate(order.deliveryDate)}</span>
                </div>
                
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <span class="order-card-status status-${order.status}">
                    ${order.status === 'pending' ? 'Pendiente' : 'Completado'}
                  </span>
                  <button class="btn-icon delete-btn delete-order-btn" title="Eliminar Pedido" data-id="${
                    order.id
                  }">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></svg>
                  </button>
                </div>
                
              </div>
              <div class="order-card-body">
                <strong>Productos:</strong>
                <ul class="order-card-products">${productsHtml}</ul>
              </div>
              <div class="order-card-footer">
                <span class="order-total">Total: ${formatCurrency(order.totalAmount)}</span>
                <div class="confirm-delivery-container">
                  <input type="checkbox" id="confirm-${order.id}" data-id="${order.id}" />
                  <label for="confirm-${order.id}">Entregado</label>
                </div>
              </div>
            `;
              // --- FIN: HTML MODIFICADO ---

              // Listener para el checkbox (Modificado)
              const confirmCheckbox = card.querySelector(`#confirm-${order.id}`);
              if (confirmCheckbox) {
                confirmCheckbox.addEventListener('change', (e) => {
                  // Solo abrimos el modal si el usuario está MARCANDO la casilla
                  if (e.target.checked) {
                    openBankSelectModal(e.target.dataset.id);
                  }
                  // No hacemos nada si la desmarca (porque no debería poder)
                });
              }

              // --- INICIO: LISTENER PARA EL NUEVO BOTÓN DE BORRAR ---
              const deleteBtn = card.querySelector('.delete-order-btn');
              if (deleteBtn) {
                deleteBtn.addEventListener('click', (e) =>
                  // Pasamos el customerName para el mensaje de confirmación
                  deleteOrder(e.currentTarget.dataset.id, order.customerName),
                );
              }
              // --- FIN: LISTENER PARA EL NUEVO BOTÓN ---

              ordersList.appendChild(card);
            });
          }
        }

        /**
         * Renderiza el widget de próximas entregas en el dashboard.
         */
        function renderUpcomingDeliveries() {
          upcomingDeliveriesList.innerHTML = '';
          const today = new Date();
          const twoDaysFromNow = new Date();
          twoDaysFromNow.setDate(today.getDate() + 2);

          const upcoming = localOrders
            .filter((order) => {
              const deliveryDate = new Date(order.deliveryDate + 'T00:00:00Z');
              return (
                order.status === 'pending' &&
                deliveryDate >= today &&
                deliveryDate <= twoDaysFromNow
              );
            })
            .sort((a, b) => new Date(a.deliveryDate) - new Date(b.deliveryDate));

          if (upcoming.length === 0) {
            dashboardNotificaciones.classList.add('hidden');
          } else {
            dashboardNotificaciones.classList.remove('hidden');
            upcoming.forEach((order) => {
              const li = document.createElement('li');
              li.innerHTML = `
              <strong>${formatDate(order.deliveryDate)}:</strong> ${order.customerName}
            `;
              upcomingDeliveriesList.appendChild(li);
            });
          }
        }

        /**
         * Maneja la creación o actualización de un pedido.
         */
        async function handleCreateOrder(event) {
          event.preventDefault();
          clearValidationErrors();
          let isValid = true;
          const customerName = orderCustomerNameInput.value.trim();
          const deliveryDate = orderDeliveryDateInput.value;

          if (
            !validateRequired(
              orderCustomerNameInput,
              document.getElementById('order-customer-name-error'),
              'El nombre del cliente es obligatorio.',
            )
          )
            isValid = false;
          if (
            !validateRequired(
              orderDeliveryDateInput,
              document.getElementById('order-delivery-date-error'),
              'La fecha de entrega es obligatoria.',
            )
          )
            isValid = false;
          if (tempOrderProducts.length === 0) {
            showMessageModal('Error', 'Debes añadir al menos un producto al pedido.', 'error');
            isValid = false;
          }

          if (!isValid) return;

          const totalAmount = tempOrderProducts.reduce((sum, p) => sum + p.price * p.quantity, 0);

          const orderData = {
            customerName: toTitleCase(customerName),
            deliveryDate: deliveryDate,
            status: 'pending', // 'pending' o 'completed'
            products: tempOrderProducts,
            totalAmount: totalAmount,
            createdAt: serverTimestamp(),
          };

          showLoading();
          try {
            await addDoc(ordersCol, orderData);
            showToast('Pedido creado');
            resetOrderForm();
            // onSnapshot se encargará de actualizar la UI
          } catch (error) {
            console.error('Error creando pedido:', error);
            showMessageModal('Error', 'No se pudo crear el pedido.', 'error');
          } finally {
            hideLoading();
          }
        }

        /**
         * Resetea el formulario de crear pedido.
         */
        function resetOrderForm() {
          createOrderForm.reset();
          tempOrderProducts = [];
          renderCurrentOrderProducts();
        }

        /**
         * Abre el modal para seleccionar productos para un pedido.
         */
        function openProductSelectModal() {
          productSelectGrid.innerHTML = '';
          if (localProducts.length === 0) {
            noProductsToSelectMessage.classList.remove('hidden');
            productSelectGrid.classList.add('hidden');
          } else {
            noProductsToSelectMessage.classList.add('hidden');
            productSelectGrid.classList.remove('hidden');

            const sortedProducts = [...localProducts].sort((a, b) => a.name.localeCompare(b.name));
            sortedProducts.forEach((product) => {
              // Buscar si este producto ya está en el pedido temporal
              const existingProduct = tempOrderProducts.find((p) => p.id === product.id);
              const currentQuantity = existingProduct ? existingProduct.quantity : 0;

              const item = document.createElement('div');
              item.className = 'product-select-option';
              item.dataset.id = product.id;
              item.dataset.name = product.name;
              item.dataset.price = product.price;
              item.innerHTML = `
              <div class="product-select-option-info">
                <h4>${product.name}</h4>
                <p>${formatCurrency(product.price)}</p>
              </div>
              <div>
                <input type="number" class="product-quantity-input" value="${currentQuantity}" min="1" step="1" />
                <button type="button" class="btn btn-primary add-product-to-order-btn">Añadir</button>
              </div>
            `;
              item.querySelector('.add-product-to-order-btn').addEventListener('click', (e) => {
                const btn = e.currentTarget;
                const quantity = parseInt(item.querySelector('.product-quantity-input').value, 10);
                if (quantity > 0) {
                  addProductToTempOrder(product.id, product.name, product.price, quantity);
                  btn.textContent = 'Añadido';
                  btn.disabled = true;
                  setTimeout(() => {
                    btn.textContent = 'Añadir';
                    btn.disabled = false;
                  }, 1000);
                }
              });
              productSelectGrid.appendChild(item);
            });
          }
          productSelectModal.classList.add('active');
        }

        /**
         * Añade un producto (con cantidad) a la lista temporal del pedido.
         */
        function addProductToTempOrder(id, name, price, quantity) {
          const existingIndex = tempOrderProducts.findIndex((p) => p.id === id);
          if (existingIndex > -1) {
            // Si ya existe, actualiza la cantidad
            tempOrderProducts[existingIndex].quantity = quantity;
          } else {
            // Si no, añádelo
            tempOrderProducts.push({ id, name, price, quantity });
          }
          console.log('Productos temporales:', tempOrderProducts);
        }

        /**
         * Confirma la selección de productos y actualiza la lista en el formulario.
         */
        function confirmProductSelection() {
          // Primero, recorremos la grilla por si se cambió una cantidad sin pulsar "Añadir"
          productSelectGrid.querySelectorAll('.product-select-option').forEach((item) => {
            const id = item.dataset.id;
            const name = item.dataset.name;
            const price = parseFloat(item.dataset.price);
            const quantity = parseInt(item.querySelector('.product-quantity-input').value, 10);
            // Añadimos/actualizamos todos los que tengan cantidad > 0
            if (quantity > 0) {
              addProductToTempOrder(id, name, price, quantity);
            }
          });

          // Filtramos por si alguno se quedó con 0
          tempOrderProducts = tempOrderProducts.filter((p) => p.quantity > 0);

          renderCurrentOrderProducts();
          productSelectModal.classList.remove('active');
        }

        /**
         * Muestra los productos en `tempOrderProducts` en el formulario de pedido.
         */
        function renderCurrentOrderProducts() {
          currentOrderProductsList.innerHTML = '';
          if (tempOrderProducts.length === 0) {
            noCurrentOrderProducts.classList.remove('hidden');
          } else {
            noCurrentOrderProducts.classList.add('hidden');
            let total = 0;
            tempOrderProducts.forEach((p) => {
              const li = document.createElement('li');
              li.textContent = `${p.quantity} x ${p.name} - ${formatCurrency(
                p.price * p.quantity,
              )}`;
              currentOrderProductsList.appendChild(li);
              total += p.price * p.quantity;
            });
            // Añadir un total
            const totalLi = document.createElement('li');
            totalLi.style.fontWeight = '600';
            totalLi.style.borderTop = '1px solid var(--border-color)';
            totalLi.style.marginTop = '0.5rem';
            totalLi.style.paddingTop = '0.5rem';
            totalLi.textContent = `Total: ${formatCurrency(total)}`;
            currentOrderProductsList.appendChild(totalLi);
          }
        }

        /**
         * ¡LA AUTOMATIZACIÓN! Confirma la entrega, actualiza el pedido y crea la transacción de venta.
         */
        async function handleConfirmDelivery(orderId, selectedBank) {
          const order = localOrders.find((o) => o.id === orderId);
          if (!order) {
            showMessageModal('Error', 'No se encontró el pedido.', 'error');
            return;
          }

          // 1. Preparar la transacción de venta
          const today = new Date().toISOString().split('T')[0]; // Fecha de hoy en YYYY-MM-DD
          const newTransaction = {
            type: 'income',
            date: today,
            description: `Venta Pedido: ${order.customerName}`,
            category: 'Ventas', // ¡Importante! Debe existir esta categoría
            bank: selectedBank, // O un banco por defecto. TODO: Preguntar al usuario
            amount: order.totalAmount,
            createdAt: serverTimestamp(),
            linkedOrderId: orderId, // Enlace al pedido
          };

          showLoading();
          try {
            // Usamos un lote para asegurar que ambas operaciones se hagan
            const batch = writeBatch(db);

            // Operación 1: Actualizar el estado del pedido
            const orderDoc = doc(db, 'artifacts', appId, 'users', userId, 'orders', orderId);
            batch.update(orderDoc, { status: 'completed' });

            // Operación 2: Añadir la nueva transacción de venta
            // Corrección: addDoc es para una colección, no para un batch.
            // Para un batch, se necesita una referencia de documento nueva.
            // ¡Corrección 2! addDoc NO se puede usar en batch. Se usa SET en un doc nuevo.
            const newTransactionRef = doc(
              collection(db, 'artifacts', appId, 'users', userId, 'transactions'),
            );
            batch.set(newTransactionRef, newTransaction);

            // Ejecutar el lote
            await batch.commit();

            showToast('¡Entrega confirmada! Venta registrada.');
            // onSnapshot se encargará de actualizar la UI (quitar el pedido de pendientes y añadir la transacción)
          } catch (error) {
            console.error('Error al confirmar entrega:', error);
            showMessageModal('Error', 'No se pudo confirmar la entrega.', 'error');
            const checkbox = document.getElementById(`confirm-${orderId}`);
            if (checkbox) checkbox.checked = false;
          } finally {
            hideLoading();
          }
        }

        // --- FIN: LÓGICA DE PRODUCTOS Y PEDIDOS ---

        // --- Utilidades (sin cambios relevantes) ---
        function showLoading() {
          loadingOverlay.classList.add('active');
        }
        function hideLoading() {
          loadingOverlay.classList.remove('active');
        }
        function showToast(message, duration = 3000) {
          const toast = document.createElement('div');
          toast.style.position = 'fixed';
          toast.style.bottom = '20px';
          toast.style.left = '50%';
          toast.style.transform = 'translateX(-50%)';
          toast.style.backgroundColor = 'rgba(0,0,0,0.7)';
          toast.style.color = 'white';
          toast.style.padding = '10px 20px';
          toast.style.borderRadius = '5px';
          toast.style.zIndex = '2000';
          toast.textContent = message;
          document.body.appendChild(toast);
          setTimeout(() => {
            toast.remove();
          }, duration);
        }
        function openConfirmModal(title, message, onConfirm) {
          confirmModalTitle.textContent = title;
          confirmModalMessage.textContent = message;
          confirmCallback = onConfirm;
          confirmModal.classList.add('active');
        }
        function closeConfirmModal() {
          confirmModal.classList.remove('active');
          confirmCallback = null;
        }
        function showMessageModal(title, content, type = 'info') {
          messageModalTitle.textContent = title;
          messageModalContent.textContent = content;
          messageModal.classList.add('active');
        }
        function closeMessageModal() {
          messageModal.classList.remove('active');
        }

        // Funciones Modal Acciones Móvil (sin cambios)
        function openMobileActionsModal(transactionId) {
          currentMobileTxId = transactionId;
          const tx = localTransactions.find((t) => t.id === transactionId);
          const desc = tx?.description || 'Transacción';
          document.getElementById('mobile-actions-title').textContent = `Opciones`;
          mobileActionsModal.classList.add('active');
        }

        function closeMobileActionsModal() {
          currentMobileTxId = null;
          mobileActionsModal.classList.remove('active');
        }

        // Validaciones (sin cambios)
        function validateRequired(inputElement, errorElement, errorMessage) {
          if (!inputElement.value || inputElement.value.trim() === '') {
            showError(errorElement, errorMessage);
            return false;
          }
          hideError(errorElement);
          return true;
        }
        function validatePositiveNumber(inputElement, errorElement, errorMessage) {
          const value = parseFloat(inputElement.value);
          if (isNaN(value) || value <= 0) {
            showError(errorElement, errorMessage);
            return false;
          }
          hideError(errorElement);
          return true;
        }
        function showError(errorElement, message) {
          if (errorElement) {
            errorElement.textContent = message;
            errorElement.classList.add('active');
          }
        }
        function hideError(errorElement) {
          if (errorElement) {
            errorElement.textContent = '';
            errorElement.classList.remove('active');
          }
        }
        function clearValidationErrors() {
          document.querySelectorAll('.input-error-message').forEach((el) => hideError(el));
        }

        // Formateo (sin cambios)
        function formatCurrency(amount) {
          return new Intl.NumberFormat('es-US', {
            style: 'currency',
            currency: 'USD',
          }).format(amount || 0);
        }
        function formatDate(dateString) {
          if (!dateString) return '';
          try {
            const date = new Date(dateString + 'T00:00:00Z');
            if (isNaN(date.getTime())) return 'Fecha inválida';
            return date.toLocaleDateString('es-ES', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric',
              timeZone: 'UTC',
            });
          } catch (e) {
            console.error('Error formateando fecha:', dateString, e);
            return 'Error fecha';
          }
        }
        function formatDateMobile(dateString) {
          if (!dateString) return '';
          try {
            return dateString.split('-')[2] || '??';
          } catch (e) {
            return '?';
          }
        }

        // MODIFICADO: usa 'localCategories'
        function getCategoryDisplay(categoryName) {
          const categoryObj = localCategories.find((c) => c.name === categoryName);
          const iconUrl = categoryObj?.icon || DEFAULT_ICON;
          return `<img src="${iconUrl}" class="category-icon-small" alt=""> <span class="category-name-text">${
            categoryName || 'Sin Categoría'
          }</span>`;
        }

        function toTitleCase(str) {
          if (!str) return '';
          return str.toLowerCase().replace(/\b\w/g, (char) => char.toUpperCase());
        }

        // --- Setup de Event Listeners (MODIFICADO) ---
        // Movimos esto aquí para que solo se configuren DESPUÉS de que el usuario esté logueado.
        function setupEventListeners() {
          const logoutBtn = document.getElementById('logout-btn-nav'); // Ahora este es el único botón
          if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
              // 'auth' está disponible desde el scope de initializeAppLogic
              signOut(auth).catch((error) => {
                console.error('Error al hacer logout (nav):', error);
              });
            });
          }
          // Navegación
          tabsContainer.addEventListener('click', (event) => {
            // Buscamos el botón más cercano al elemento que se clickeó
            const clickedButton = event.target.closest('.tab-button');

            // Si se encontró un botón (no importa si se hizo clic en la img, el span o el botón mismo)
            if (clickedButton && clickedButton.dataset.tab) {
              switchTab(clickedButton.dataset.tab);
            }
          });

          // Filtros
          document
            .getElementById('filter-bank')
            .addEventListener('change', renderTransactionsTable);
          document
            .getElementById('filter-month')
            .addEventListener('change', renderTransactionsTable);
          document.getElementById('clear-filters-btn').addEventListener('click', () => {
            document.getElementById('filter-bank').value = 'all';
            document.getElementById('filter-month').value = '';
            renderTransactionsTable();
          });

          const toggleFiltersBtn = document.getElementById('toggle-filters-btn');
          const filtersContainer = document.getElementById('filters-container');

          toggleFiltersBtn.addEventListener('click', () => {
            const isVisible = filtersContainer.classList.toggle('show-mobile-filters');
            const btnText = toggleFiltersBtn.querySelector('span');
            if (isVisible) {
              btnText.textContent = 'Ocultar Filtros';
            } else {
              btnText.textContent = 'Mostrar Filtros';
            }
          });

          // --- MODIFICADO: Botón Añadir Transacción ahora abre el modal de calculadora ---
          document
            .getElementById('add-transaction-btn')
            .addEventListener('click', openCalculatorModal);

          // Modal Transacción (de Edición)
          document
            .getElementById('close-transaction-modal-btn')
            .addEventListener('click', closeTransactionModal);
          document
            .getElementById('cancel-transaction-btn')
            .addEventListener('click', closeTransactionModal);
          transactionModal.addEventListener('click', (e) => {
            if (e.target === transactionModal) closeTransactionModal();
          });
          transactionForm.addEventListener('submit', handleTransactionFormSubmit);

          // --- INICIO: NUEVOS LISTENERS PARA EL MODAL DE CALCULADORA ---
          btnGasto.addEventListener('click', () => setTipoRegistro('expense'));
          btnIngreso.addEventListener('click', () => setTipoRegistro('income'));
          comentarioToggleBtn.addEventListener('click', toggleComentario);
          keypad.addEventListener('click', handleKeypadClick);
          totalBtn.addEventListener('click', handleTotalClick);

          document
            .getElementById('close-calculator-modal-btn')
            .addEventListener('click', closeCalculatorModal); // <-- MODIFICADO

          calculatorModal.addEventListener('click', (e) => {
            // Cerrar si se hace clic fuera del modal-content
            if (e.target === calculatorModal) {
              closeCalculatorModal(); // <-- MODIFICADO
            }
          });

          document.getElementById('close-calculator-modal-btn').addEventListener('click', () => {
            calculatorModal.classList.remove('active');
          });
          calculatorModal.addEventListener('click', (e) => {
            // Cerrar si se hace clic fuera del modal-content
            if (e.target === calculatorModal) {
              calculatorModal.classList.remove('active');
            }
          });
          // --- FIN: NUEVOS LISTENERS DE CALCULADORA ---

          // --- INICIO: NUEVOS LISTENERS PARA EL MODAL DE SELECCIÓN DE CATEGORÍA ---
          categorySelectGrid.addEventListener('click', handleCategorySelection);
          closeCategorySelectModalBtn.addEventListener('click', () =>
            categorySelectModal.classList.remove('active'),
          );
          categorySelectModal.addEventListener('click', (e) => {
            if (e.target === categorySelectModal) {
              categorySelectModal.classList.remove('active');
            }
          });
          // --- FIN: NUEVOS LISTENERS DE SELECCIÓN DE CATEGORÍA ---

          // Botón Añadir Banco
          addBankBtn.addEventListener('click', handleAddBank);
          // Botón Abrir Modal Añadir Categoría
          document
            .getElementById('open-add-category-modal-btn')
            .addEventListener('click', openAddCategoryModal);
          // Modal Categoría
          document
            .getElementById('close-icon-modal-btn')
            .addEventListener('click', closeAddCategoryModal);
          document
            .getElementById('cancel-category-btn')
            .addEventListener('click', closeAddCategoryModal);
          categoryIconModal.addEventListener('click', (e) => {
            if (e.target === categoryIconModal) closeAddCategoryModal();
          });
          saveNewCategoryBtn.addEventListener('click', handleSaveCategory);
          // Modal Confirmación
          confirmModalCancelBtn.addEventListener('click', closeConfirmModal);
          closeConfirmModalBtn.addEventListener('click', closeConfirmModal);
          confirmModal.addEventListener('click', (e) => {
            if (e.target === confirmModal) closeConfirmModal();
          });
          confirmModalConfirmBtn.addEventListener('click', () => {
            if (typeof confirmCallback === 'function') confirmCallback();
            closeConfirmModal();
          });
          // Modal Mensaje
          messageModalCloseBtn.addEventListener('click', closeMessageModal);
          closeMessageModalHeaderBtn.addEventListener('click', closeMessageModal);
          messageModal.addEventListener('click', (e) => {
            if (e.target === messageModal) closeMessageModal();
          });

          if (confirmDeleteAllCheckbox) {
            confirmDeleteAllCheckbox.addEventListener('change', () => {
              if (deleteAllDataBtn) {
                deleteAllDataBtn.disabled = !confirmDeleteAllCheckbox.checked;
              }
            });
          }
          if (deleteAllDataBtn) {
            deleteAllDataBtn.addEventListener('click', deleteAllData);
          }

          // Modal Acciones Móvil
          document
            .getElementById('close-mobile-actions-modal-btn')
            .addEventListener('click', closeMobileActionsModal);
          document
            .getElementById('mobile-actions-cancel-btn')
            .addEventListener('click', closeMobileActionsModal);
          mobileActionsModal.addEventListener('click', (e) => {
            if (e.target === mobileActionsModal) closeMobileActionsModal();
          });

          mobileActionsEditBtn.addEventListener('click', () => {
            if (currentMobileTxId) {
              openTransactionModal(currentMobileTxId);
            }
            closeMobileActionsModal();
          });

          mobileActionsDeleteBtn.addEventListener('click', () => {
            if (currentMobileTxId) {
              deleteTransaction(currentMobileTxId);
            }
            closeMobileActionsModal();
          });

          // --- INICIO: NUEVOS LISTENERS DE PRODUCTOS Y PEDIDOS ---
          addProductForm.addEventListener('submit', handleAddProduct);
          createOrderForm.addEventListener('submit', handleCreateOrder);
          openProductSelectModalBtn.addEventListener('click', openProductSelectModal);
          closeProductSelectModalBtn.addEventListener('click', () =>
            productSelectModal.classList.remove('active'),
          );
          productSelectModal.addEventListener('click', (e) => {
            if (e.target === productSelectModal) productSelectModal.classList.remove('active');
          });
          confirmProductSelectionBtn.addEventListener('click', confirmProductSelection);
          // --- INICIO: LISTENERS MODAL SELECCIÓN DE BANCO ---
          bankSelectModalConfirmBtn.addEventListener('click', handleBankSelectionConfirm);
          bankSelectModalCancelBtn.addEventListener('click', closeBankSelectModal);
          closeBankSelectModalBtn.addEventListener('click', closeBankSelectModal);
          bankSelectModal.addEventListener('click', (e) => {
            if (e.target === bankSelectModal) closeBankSelectModal();
          });
          // --- FIN: LISTENERS MODAL SELECCIÓN DE BANCO ---
          // --- FIN: NUEVOS LISTENERS DE PRODUCTOS Y PEDIDOS ---
          /* PEGAR ESTO AL FINAL DE LA FUNCIÓN setupEventListeners() */

          // --- LÓGICA PARA EL TOOLTIP FLOTANTE (Descripción en Móvil) ---
          document.body.addEventListener('click', (e) => {
            // 1. Si ya hay un tooltip abierto, lo cerramos primero
            const existingTooltip = document.querySelector('.info-tooltip');
            if (existingTooltip) {
              existingTooltip.remove();
            }

            // 2. Verificamos si el clic fue en nuestro botón .info-btn (o dentro de él)
            const infoBtn = e.target.closest('.info-btn');

            if (infoBtn) {
              e.stopPropagation(); // Evita que el clic cierre el tooltip inmediatamente

              const description = infoBtn.dataset.description;

              // Crear el elemento flotante
              const tooltip = document.createElement('div');
              tooltip.className = 'info-tooltip';
              tooltip.textContent = description;
              document.body.appendChild(tooltip);

              // Calcular posición
              const rect = infoBtn.getBoundingClientRect();

              // Lógica inteligente de posición para que no se salga de la pantalla en móviles
              let leftPos = rect.left;
              // Si está muy a la derecha (borde derecho), moverlo hacia la izquierda
              if (leftPos + 200 > window.innerWidth) {
                leftPos = window.innerWidth - 220;
              }
              // Si el cálculo da negativo (muy a la izquierda), fijar margen mínimo
              if (leftPos < 10) leftPos = 10;

              tooltip.style.left = `${leftPos}px`;
              tooltip.style.top = `${rect.bottom + 8}px`; // Justo debajo del botón

              // Pequeño retraso para permitir la transición CSS
              requestAnimationFrame(() => {
                tooltip.classList.add('visible');
              });
            }
          });

          // Cerrar el tooltip si se hace scroll (mejora la experiencia en móvil)
          window.addEventListener(
            'scroll',
            () => {
              const existingTooltip = document.querySelector('.info-tooltip');
              if (existingTooltip) existingTooltip.remove();
            },
            { passive: true },
          );
          // --- FIN: LÓGICA PARA EL TOOLTIP FLOTANTE (Descripción en Móvil) ---
        }

        // --- INICIO: NUEVAS FUNCIONES PARA EL MODAL DE CALCULADORA ---

        /**
         * Abre el nuevo modal de calculadora y resetea su estado.
         */
        function openCalculatorModal() {
          tempTransactionData = {}; // Resetear datos temporales
          currentCalculatorExpression = '0';
          registroDisplay.textContent = '0';
          registroFecha.valueAsDate = new Date(); // Fecha de hoy
          comentarioInput.value = '';
          comentarioInput.classList.add('hidden');
          comentarioToggleBtn.classList.remove('active');

          // === INICIO DE LA MODIFICACIÓN ===
          // Poblar el nuevo selector de bancos
          populateSelectWithOptions(
            'registro-banco',
            localBanks,
            null,
            null,
            'Selecciona un banco...',
            '',
            true,
          );
          // Limpiar error (si lo hubo)
          hideError(document.getElementById('registro-banco-error'));
          // === FIN DE LA MODIFICACIÓN ===

          // Por defecto Gasto
          setTipoRegistro('income'); // Modificado a 'expense' como default

          calculatorModal.classList.add('active');
          document.addEventListener('keydown', handleKeyboardInput);
        }

        /**
         * Cierra el modal de la calculadora y limpia los listeners del teclado.
         */
        function closeCalculatorModal() {
          calculatorModal.classList.remove('active');
          // MUY IMPORTANTE: Apagamos el listener del teclado para que no interfiera
          document.removeEventListener('keydown', handleKeyboardInput);
        }
        /**
         * Establece el tipo de registro (ingreso/gasto)...
         */
        // ... (el resto de tus funciones)

        /**
         * Establece el tipo de registro (ingreso/gasto) y actualiza el tema del modal.
         * @param {string} tipo - 'income' o 'expense'
         */
        function setTipoRegistro(tipo) {
          const modalContent = calculatorModal.querySelector('.modal-content');
          tempTransactionData.type = tipo;

          if (tipo === 'income') {
            btnIngreso.classList.add('active');
            btnGasto.classList.remove('active');
            modalContent.classList.add('modal-ingreso');
            modalContent.classList.remove('modal-gasto');
          } else {
            btnGasto.classList.add('active');
            btnIngreso.classList.remove('active');
            modalContent.classList.add('modal-gasto');
            modalContent.classList.remove('modal-ingreso');
          }
        }

        /**
         * Muestra u oculta el campo de comentario opcional.
         */
        function toggleComentario() {
          comentarioInput.classList.toggle('hidden');
          comentarioToggleBtn.classList.toggle('active');
        }

        /**
         * Maneja la entrada de datos desde el teclado físico.
         * @param {KeyboardEvent} event
         */
        function handleKeyboardInput(event) {
          // Si el usuario está escribiendo en el campo de comentario, no hacemos nada
          if (
            event.target === comentarioInput ||
            event.target === newProductNameInput ||
            event.target === newProductPriceInput ||
            event.target === orderCustomerNameInput
          ) {
            return;
          }
          // Prevenimos que la tecla haga su acción por defecto (ej. escribir en la pág)
          // event.preventDefault(); // <-- ¡Eliminada de aquí!

          const key = event.key;

          if (/[0-9.]/.test(key)) {
            event.preventDefault(); // <-- Movida aquí
            handleKeypadClick({ target: { dataset: { key: key } } });
          } else if (/[+\-*/]/.test(key)) {
            event.preventDefault(); // <-- Movida aquí
            handleKeypadClick({ target: { dataset: { key: key } } });
          } else if (key === 'Enter' || key === '=') {
            event.preventDefault(); // <-- Movida aquí
            handleTotalClick();
          } else if (key === 'Backspace' || key === 'Delete' || key === 'c' || key === 'C') {
            event.preventDefault(); // <-- Movida aquí
            handleKeypadClick({ target: { dataset: { key: 'C' } } });
          }
          // Si la tecla es F12, F5, etc., no entra en ningún 'if'
          // y el navegador ejecuta su acción por defecto.
        }

        /**
         * Maneja los clics en el teclado de la calculadora.
         */
        // ... (el resto de tus funciones)
        /**
         * Maneja los clics en el teclado de la calculadora.
         * @param {Event} event - El evento de clic
         */
        function handleKeypadClick(event) {
          const key = event.target.dataset.key;
          if (!key) return;

          if (key === 'C') {
            currentCalculatorExpression = '0';
          } else if (currentCalculatorExpression === '0' && key !== '.') {
            currentCalculatorExpression = key;
          } else {
            currentCalculatorExpression += key;
          }

          registroDisplay.textContent = currentCalculatorExpression;
        }

        /**
         * Evalúa de forma segura una expresión matemática simple.
         * @param {string} expression - La expresión a calcular (ej. "10+5-3")
         * @returns {number} - El resultado del cálculo.
         */
        function safeEval(expression) {
          try {
            // Filtro de seguridad: solo permite números, operadores, y punto decimal.
            if (!/^[0-9+\-*/. ]+$/.test(expression)) {
              console.error('Expresión inválida detectada:', expression);
              return 0;
            }
            // Usa Function en lugar de eval() directo para un entorno más seguro
            return new Function('return ' + expression)();
          } catch (e) {
            console.error('Error al evaluar la expresión:', e);
            return 0; // Devuelve 0 si hay un error de sintaxis
          }
        }

        /**
         * Maneja el clic en el botón "Total". Calcula el monto y abre el modal de categorías.
         */
        function handleTotalClick() {
          // === INICIO DE LA MODIFICACIÓN ===
          // 1. Validar que se seleccionó un banco
          const bancoSelect = document.getElementById('registro-banco');
          const bancoError = document.getElementById('registro-banco-error');
          if (!validateRequired(bancoSelect, bancoError, 'Debes seleccionar un banco.')) {
            return; // Detener si no es válido
          }
          const selectedBank = bancoSelect.value;
          // === FIN DE LA MODIFICACIÓN ===

          const totalAmount = safeEval(currentCalculatorExpression);

          if (totalAmount <= 0) {
            showMessageModal('Monto Inválido', 'El monto debe ser mayor que cero.', 'error');
            return;
          }

          // Guardar datos temporalmente
          tempTransactionData.amount = totalAmount;
          tempTransactionData.date = registroFecha.value;
          tempTransactionData.description = comentarioInput.value.trim() || '';
          tempTransactionData.bank = selectedBank; // <-- 2. AÑADIR EL BANCO GUARDADO
          // El tipo (type) ya se guardó al presionar los botones

          // Rellenar la descripción si está vacía
          if (tempTransactionData.description === '') {
            tempTransactionData.description =
              tempTransactionData.type === 'income' ? 'Ingreso' : 'Gasto';
          }
          closeCalculatorModal();
          // Resetear y cerrar modal de calculadora
          // calculatorModal.classList.remove('active'); //<- closeCalculatorModal() ya lo hace
          currentCalculatorExpression = '0';
          registroDisplay.textContent = '0';

          // Abrir modal de selección de categoría
          openCategorySelectModal();
        }

        /**
         * Abre el modal de selección de categoría y lo puebla.
         */
        function openCategorySelectModal() {
          categorySelectGrid.innerHTML = ''; // Limpiar grid

          // Filtrar categorías (ej. no mostrar "Transferencia") si es necesario
          const categoriesToShow = localCategories.filter((cat) => cat.name !== 'Transferencia');

          if (categoriesToShow.length === 0) {
            showMessageModal(
              'Sin Categorías',
              'No tienes categorías configuradas. Por favor, añade algunas en la pestaña de Configuración.',
              'error',
            );
            return;
          }

          categoriesToShow.forEach((cat) => {
            const option = document.createElement('button');
            option.className = 'category-select-option';
            option.dataset.categoryName = cat.name;
            option.innerHTML = `
              <img src="${cat.icon || DEFAULT_ICON}" alt="${cat.name}">
              <span>${cat.name}</span>
            `;
            categorySelectGrid.appendChild(option);
          });

          categorySelectModal.classList.add('active');
        }

        /**
         * Maneja el clic en una categoría, guarda la transacción y cierra todo.
         * @param {Event} event - El evento de clic
         */
        async function handleCategorySelection(event) {
          const selectedCategoryBtn = event.target.closest('.category-select-option');
          if (!selectedCategoryBtn) return;

          const categoryName = selectedCategoryBtn.dataset.categoryName;
          tempTransactionData.category = categoryName;

          // ¡Aquí se guarda!
          await saveTransactionFromCalculator(tempTransactionData);

          // Cerrar modal
          categorySelectModal.classList.remove('active');
          // Resetear datos temporales
          tempTransactionData = {};
        }

        /**
         * Guarda la transacción final en Firestore.
         * @param {object} data - El objeto de transacción completo.
         */
        async function saveTransactionFromCalculator(data) {
          showLoading();

          // Asegurarnos de que tiene la fecha de creación del servidor
          const dataToSave = {
            ...data,
            createdAt: serverTimestamp(),
          };

          try {
            await addDoc(transactionsCol, dataToSave);
            showToast('Transacción guardada');
            // onSnapshot se encargará de actualizar la UI
          } catch (error) {
            console.error('Error guardando transacción desde calculadora:', error);
            showMessageModal('Error', 'No se pudo guardar la transacción.', 'error');
          } finally {
            hideLoading();
          }
        }

        // --- FIN: NUEVAS FUNCIONES PARA EL MODAL DE CALCULADORA ---

        // --- Funciones para poblar Desplegables (MODIFICADA) ---
        function populateModalDropdowns() {
          // Esta función ahora solo puebla el modal de EDICIÓN
          populateSelectWithOptions(
            'transaction-category',
            localCategories,
            'name',
            'name',
            'Selecciona categoría...',
            '',
            true,
          );
          populateSelectWithOptions(
            'transaction-bank',
            localBanks,
            null,
            null,
            'Selecciona banco/cuenta...',
            '',
            true,
          );

          populateSelectWithOptions(
            'filter-bank',
            localBanks,
            null,
            null,
            'Todos los Bancos',
            'all',
            false,
          );
        }

        // populateSelectWithOptions (sin cambios)
        function populateSelectWithOptions(
          elementId,
          options,
          valueKey,
          textKey,
          placeholderText = null,
          placeholderValue = '',
          placeholderDisabled = false,
        ) {
          const selectElement = document.getElementById(elementId);
          if (!selectElement) return;
          const currentValue = selectElement.value;
          selectElement.innerHTML = '';
          if (placeholderText) {
            const placeholderOption = document.createElement('option');
            placeholderOption.value = placeholderValue;
            placeholderOption.textContent = placeholderText;
            placeholderOption.disabled = placeholderDisabled;
            if (currentValue !== placeholderValue) {
              placeholderOption.selected = false;
            } else {
              placeholderOption.selected = true;
            }
            if (!placeholderDisabled && !currentValue) {
              placeholderOption.selected = true;
            }
            if (placeholderDisabled && !currentValue) {
              placeholderOption.selected = true;
            }

            selectElement.appendChild(placeholderOption);
          }

          // Ordenamos las opciones alfabéticamente
          const sortedOptions = [...options].sort((a, b) => {
            const aText = textKey ? a[textKey] : a;
            const bText = textKey ? b[textKey] : b;
            return aText.localeCompare(bText);
          });

          sortedOptions.forEach((optionData) => {
            const option = document.createElement('option');
            option.value = valueKey ? optionData[valueKey] : optionData;
            option.textContent = textKey ? optionData[textKey] : optionData;
            selectElement.appendChild(option);
          });

          if (
            currentValue &&
            Array.from(selectElement.options).some((opt) => opt.value === currentValue)
          ) {
            selectElement.value = currentValue;
          } else if (placeholderText) {
            selectElement.value = placeholderValue;
          } else if (selectElement.options.length > 0) {
            selectElement.selectedIndex = 0;
          }
        }
      }; // Fin de initializeAppLogic
    </script>
  </body>
</html>
